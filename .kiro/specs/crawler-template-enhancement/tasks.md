# 实现计划：采集模板配置增强

## 概述

本实现计划将采集模板配置增强功能分解为可执行的任务。任务按照从后端到前端、从基础到高级的顺序组织，确保每个任务都可以独立测试和验证。

## 任务

### 第一阶段：数据库和后端基础

- [x] 1. 扩展数据库表结构
  - 为 crawler_templates 表添加分页配置字段
  - 添加字段：pagination_enabled, max_pages, url_pattern, next_page_selector
  - 编写数据库迁移脚本
  - _需求: 9.1, 9.2, 9.3, 9.4, 9.5_

- [x] 1.1 编写数据库迁移测试

  - 测试字段添加成功
  - 测试默认值正确
  - _需求: 9.1_

- [x] 2. 实现选择器验证API
  - [x] 2.1 创建 POST /api/admin/ai/crawler/validate-selector 路由
    - 接收 url 和 selector 参数
    - 使用 cheerio 解析HTML并验证选择器
    - 返回验证结果和匹配元素数量
    - _需求: 7.1, 7.2_

  - [x] 2.2 编写选择器验证单元测试

    - 测试有效选择器返回正确匹配数量
    - 测试无效选择器返回错误
    - 测试空选择器处理
    - _需求: 7.3_

- [x] 3. 增强数据预览API
  - [x] 3.1 修改 POST /api/admin/ai/crawler/preview 接口
    - 添加 limit 参数，默认值为 10
    - 返回数据总数
    - 支持分页参数
    - _需求: 2.1, 2.3, 2.4_

  - [x] 3.2 编写数据预览单元测试

    - 测试默认返回10条数据
    - 测试数据少于10条时返回全部
    - 测试分页功能
    - _需求: 2.1, 2.3_

- [x] 4. 实现AI失败诊断API
  - [x] 4.1 创建 POST /api/admin/ai/crawler/diagnose 路由
    - 接收 url, selectors, error 参数
    - 调用AI服务分析失败原因
    - 检查选择器是否匹配元素
    - 检查网页是否动态加载
    - 返回诊断结果和修复建议
    - _需求: 6.2, 6.3, 6.4, 6.5_

  - [x] 4.2 编写AI诊断单元测试

    - 测试选择器不匹配的诊断
    - 测试动态加载检测
    - 测试推荐策略生成
    - _需求: 6.3, 6.4_

- [x] 5. 实现模板测试API
  - [x] 5.1 创建 POST /api/admin/ai/crawler/test 路由
    - 接收完整的模板配置
    - 执行采集测试
    - 返回测试结果和采集数据
    - _需求: 10.2, 10.3, 10.4_

  - [x] 5.2 编写模板测试单元测试

    - 测试成功场景
    - 测试失败场景
    - 测试错误处理
    - _需求: 10.3, 10.4_

### 第二阶段：前端基础组件

- [x] 6. 创建配置表单组件
  - [x] 6.1 实现 ConfigForm.vue 组件
    - 创建基本信息表单（名称、URL、部门、数据类型）
    - 创建容器选择器输入
    - 实现字段动态添加/删除功能
    - 添加表单验证
    - _需求: 8.1, 8.2, 8.3, 8.4, 8.5_

  - [ ]* 6.2 编写配置表单组件测试
    - 测试表单渲染
    - 测试字段添加删除
    - 测试数据绑定
    - _需求: 8.3, 8.5_

- [x] 7. 创建分页配置组件
  - [x] 7.1 实现 PaginationConfig.vue 组件
    - 创建启用分页开关
    - 创建最大页数输入
    - 创建URL模式输入
    - 创建分页选择器输入
    - 实现条件显示逻辑
    - _需求: 9.1, 9.2, 9.3, 9.4, 9.5_

  - [ ]* 7.2 编写分页配置组件测试
    - 测试开关切换
    - 测试条件显示
    - 测试数据绑定
    - _需求: 9.2_

- [x] 8. 创建选择器验证组件
  - [x] 8.1 实现 SelectorValidator.vue 组件
    - 实现实时验证逻辑（防抖300ms）
    - 显示匹配元素数量
    - 显示验证错误和警告
    - 添加加载状态
    - _需求: 7.1, 7.2, 7.3, 7.4_

  - [ ]* 8.2 编写选择器验证组件测试
    - 测试防抖功能
    - 测试验证结果显示
    - 测试错误处理
    - _需求: 7.1, 7.3, 7.4_

### 第三阶段：预览面板功能

- [x] 9. 创建网页预览组件
  - [x] 9.1 实现 WebpagePreview.vue 组件
    - 使用iframe加载网页
    - 实现加载状态显示
    - 添加刷新和新窗口打开功能
    - _需求: 1.3_

  - [ ]* 9.2 编写网页预览组件测试
    - 测试iframe加载
    - 测试加载状态
    - 测试错误处理
    - _需求: 1.3_

- [x] 10. 实现元素选择器功能
  - [x] 10.1 创建元素选择器脚本
    - 编写注入到iframe的JavaScript脚本
    - 实现鼠标悬停高亮
    - 实现点击选择元素
    - 实现CSS选择器生成算法
    - _需求: 3.1, 3.2, 3.3_

  - [x] 10.2 集成元素选择器到网页预览组件
    - 添加启用/停用按钮
    - 处理iframe通信
    - 将选择器填充到表单
    - _需求: 3.1, 3.4, 3.5_

  - [ ]* 10.3 编写元素选择器测试
    - 测试选择器生成算法
    - 测试状态切换
    - 测试数据传递
    - _需求: 3.3, 3.4, 3.5_

- [x] 11. 创建选择器可视化组件
  - [x] 11.1 实现 SelectorVisualization.vue 组件
    - 显示所有配置的选择器列表
    - 显示每个选择器的验证状态
    - 提供复制选择器功能
    - _需求: 1.4_

  - [ ]* 11.2 编写选择器可视化组件测试
    - 测试列表渲染
    - 测试验证状态显示
    - _需求: 1.4_

- [x] 12. 创建数据预览组件
  - [x] 12.1 实现 DataPreviewTable.vue 组件
    - 创建数据表格
    - 实现分页功能（默认10条）
    - 显示总数据条数
    - 格式化数据显示
    - _需求: 1.5, 2.1, 2.2, 2.4_

  - [ ]* 12.2 编写数据预览组件测试
    - 测试默认10条显示
    - 测试分页功能
    - 测试数据格式化
    - _需求: 2.1, 2.2_

- [x] 13. 创建预览面板容器组件
  - [x] 13.1 实现 PreviewPanel.vue 组件
    - 创建标签页容器
    - 管理三个预览标签页
    - 处理标签页切换
    - _需求: 1.1, 1.2_

  - [ ]* 13.2 编写预览面板组件测试
    - 测试标签页渲染
    - 测试标签页切换
    - _需求: 1.1, 1.2_

### 第四阶段：AI功能集成

- [x] 14. 实现AI智能分析功能
  - [x] 14.1 创建 AIAnalysisPanel.vue 组件
    - 显示AI推荐字段列表
    - 显示置信度
    - 提供应用推荐按钮
    - 支持编辑推荐选择器
    - _需求: 4.2, 4.3, 4.4, 4.5_

  - [x] 14.2 集成AI分析到主组件
    - 添加AI智能分析按钮
    - 调用AI分析API
    - 应用推荐到表单
    - _需求: 4.1, 4.4_

  - [ ]* 14.3 编写AI分析功能测试
    - 测试API调用
    - 测试推荐应用
    - 测试编辑功能
    - _需求: 4.1, 4.4, 4.5_

- [x] 15. 实现AI失败诊断功能
  - [x] 15.1 创建 DiagnosisPanel.vue 组件
    - 显示失败原因
    - 显示修复建议列表
    - 提供应用推荐策略按钮
    - _需求: 6.5, 6.6_

  - [x] 15.2 集成失败诊断到数据预览
    - 检测预览失败
    - 显示AI分析按钮
    - 调用诊断API
    - 应用推荐策略
    - _需求: 6.1, 6.2, 6.6_

  - [ ]* 15.3 编写失败诊断功能测试
    - 测试失败检测
    - 测试诊断调用
    - 测试策略应用
    - _需求: 6.1, 6.2, 6.6_

### 第五阶段：主页面集成

- [x] 16. 重构采集模板配置主页面
  - [x] 16.1 修改 crawler-template-config.vue
    - 采用左右分栏布局
    - 集成配置表单组件
    - 集成预览面板组件
    - 实现组件间通信
    - _需求: 1.1_

  - [x] 16.2 实现保存功能
    - 添加保存按钮
    - 调用保存API
    - 保存后自动预览
    - 自动切换到数据预览标签页
    - _需求: 5.1, 5.2, 5.5, 8.6_

  - [x] 16.3 实现测试功能
    - 添加测试按钮
    - 调用测试API
    - 显示测试结果
    - 测试后保持表单可编辑
    - _需求: 10.1, 10.2, 10.3, 10.4, 10.5_

  - [ ]* 16.4 编写主页面集成测试
    - 测试布局渲染
    - 测试组件通信
    - 测试保存流程
    - 测试测试流程
    - _需求: 5.1, 5.5, 10.2, 10.5_

### 第六阶段：用户体验优化

- [x] 17. 添加加载状态和反馈
  - 为所有异步操作添加加载状态
  - 添加操作成功/失败提示
  - 优化错误消息显示
  - _需求: 5.4_

- [x] 18. 实现键盘快捷键
  - Ctrl+S 保存
  - Ctrl+T 测试
  - Esc 关闭弹窗
  - _需求: 非功能需求_

- [x] 19. 优化响应式布局
  - 适配不同屏幕尺寸
  - 优化移动端显示
  - 添加折叠/展开功能
  - _需求: 非功能需求_

- [x] 20. 添加操作提示和帮助
  - 添加工具提示
  - 添加操作指引
  - 添加帮助文档链接
  - _需求: 非功能需求_

### 第七阶段：测试和优化

- [ ] 21. 端到端测试
  - [ ] 21.1 测试完整配置流程
    - 输入URL → AI分析 → 应用推荐 → 预览数据 → 保存模板
    - _需求: 所有需求_

  - [ ] 21.2 测试手动配置流程
    - 输入URL → 启用元素选择器 → 点击元素 → 预览数据 → 调整选择器 → 保存
    - _需求: 3.1, 3.2, 3.3, 3.4, 3.5_

  - [ ] 21.3 测试失败诊断流程
    - 配置错误选择器 → 预览失败 → AI诊断 → 应用建议 → 重新预览
    - _需求: 6.1, 6.2, 6.5, 6.6_

- [ ] 22. 性能优化
  - 优化网页加载速度
  - 优化数据预览响应时间
  - 优化AI分析响应时间
  - 添加缓存机制
  - _需求: 非功能需求_

- [ ] 23. 安全加固
  - 添加URL验证
  - 防止SSRF攻击
  - 转义用户输入
  - 添加权限检查
  - _需求: 非功能需求_

- [x] 24. 文档和部署
  - 编写用户使用文档
  - 编写开发者文档
  - 更新API文档
  - 准备部署脚本
  - _需求: 非功能需求_

## 检查点

### 检查点 1: 后端基础完成
- 确保所有后端API正常工作
- 确保数据库迁移成功
- 确保单元测试通过
- 询问用户是否有问题

### 检查点 2: 前端基础组件完成
- 确保配置表单正常工作
- 确保分页配置正常工作
- 确保选择器验证正常工作
- 询问用户是否有问题

### 检查点 3: 预览面板完成
- 确保三个预览标签页正常工作
- 确保元素选择器正常工作
- 确保数据预览正常工作
- 询问用户是否有问题

### 检查点 4: AI功能完成
- 确保AI智能分析正常工作
- 确保AI失败诊断正常工作
- 确保推荐应用正常工作
- 询问用户是否有问题

### 检查点 5: 主页面集成完成
- 确保所有组件正确集成
- 确保保存和测试功能正常
- 确保用户体验流畅
- 询问用户是否有问题

### 检查点 6: 测试和优化完成
- 确保所有测试通过
- 确保性能达标
- 确保安全加固完成
- 准备上线

## 注意事项

1. **任务标记说明**
   - `[ ]` 表示核心实现任务，必须完成
   - `[ ]*` 表示测试任务，标记为可选但强烈建议完成
   - 每个任务都引用了对应的需求编号

2. **实现顺序**
   - 按照任务编号顺序实现
   - 完成一个阶段后进行检查点验证
   - 遇到问题及时反馈

3. **测试要求**
   - 每个功能实现后立即测试
   - 使用浏览器开发者工具调试
   - 记录发现的问题

4. **代码质量**
   - 遵循项目代码规范
   - 添加必要的注释
   - 保持代码简洁可读

5. **用户反馈**
   - 每个检查点都需要用户确认
   - 根据用户反馈调整实现
   - 及时沟通遇到的问题
