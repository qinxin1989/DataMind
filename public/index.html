<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI æ•°æ®å·¥ä½œå° | æ•°æ®é—®ç­” Â· RAG Â· åˆ†æ</title>
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: radial-gradient(circle at top left, #f4f7ff 0, #f9fbff 40%, #f5f7fb 100%);
      color: #1f2933;
      -webkit-font-smoothing: antialiased;
    }
    a { text-decoration: none; color: inherit; }
    .app-shell {
      height: 100vh;
      display: flex;
      background: #f5f7fb;
    }
    /* å·¦ä¾§å¯¼èˆªï¼Œå‚è€ƒç¡…åŸºæµåŠ¨æ§åˆ¶å° */
    .sidebar {
      width: 220px;
      background: rgba(10, 26, 56, 0.98);
      color: #e5edf7;
      display: flex;
      flex-direction: column;
      padding: 14px 12px;
      box-shadow: 1px 0 0 rgba(15, 23, 42, 0.3);
    }
    .logo-row {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 6px 8px 10px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
      margin-bottom: 10px;
    }
    .logo-mark {
      width: 26px;
      height: 26px;
      border-radius: 9px;
      background: radial-gradient(circle at 30% 20%, #4fd1c5 0, #22c1c3 28%, #1d7cf2 60%, #1a3fb3 100%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
      color: #f9fafb;
      box-shadow: 0 8px 24px rgba(15, 118, 255, 0.35);
    }
    .logo-text-main {
      font-size: 15px;
      font-weight: 600;
      letter-spacing: 0.02em;
    }
    .logo-text-sub {
      font-size: 11px;
      color: rgba(148, 163, 184, 0.85);
    }
    .nav-section-title {
      font-size: 11px;
      text-transform: uppercase;
      color: rgba(148, 163, 184, 0.8);
      padding: 8px 8px 4px;
      letter-spacing: 0.08em;
    }
    .nav-list {
      list-style: none;
      margin-top: 4px;
    }
    .nav-item {
      border-radius: 6px;
      margin-bottom: 2px;
      overflow: hidden;
    }
    .nav-link {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 7px 9px;
      font-size: 13px;
      color: #d0e2ff;
      border-radius: 6px;
      transition: all 0.15s ease;
      cursor: pointer;
    }
    .nav-link-left {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .nav-icon {
      width: 18px;
      text-align: center;
      opacity: 0.9;
      font-size: 14px;
    }
    .nav-link span {
      white-space: nowrap;
    }
    .nav-link.badge span.badge-text {
      font-size: 10px;
      padding: 1px 6px;
      border-radius: 999px;
      background: rgba(34, 211, 238, 0.14);
      color: #5eead4;
      border: 1px solid rgba(34, 211, 238, 0.5);
    }
    .nav-link:hover {
      background: linear-gradient(90deg, rgba(56, 189, 248, 0.18), rgba(59, 130, 246, 0.14));
      color: #f9fafb;
    }
    .nav-link.active {
      background: linear-gradient(90deg, rgba(56, 189, 248, 0.32), rgba(59, 130, 246, 0.28));
      color: #f9fafb;
      box-shadow: 0 0 0 1px rgba(191, 219, 254, 0.32);
    }
    .nav-footer {
      margin-top: auto;
      padding: 8px 6px 4px;
      border-top: 1px solid rgba(148, 163, 184, 0.2);
      font-size: 11px;
      color: rgba(148, 163, 184, 0.85);
    }
    .nav-footer-user {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 4px;
    }
    .nav-footer-user-left {
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .avatar {
      width: 22px;
      height: 22px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #38bdf8 0, #0ea5e9 45%, #0369a1 100%);
      color: #e5f2ff;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 11px;
      font-weight: 600;
    }
    .logout-link {
      cursor: pointer;
      color: rgba(248, 250, 252, 0.9);
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.5);
      font-size: 11px;
    }
    .logout-link:hover {
      background: rgba(239, 68, 68, 0.12);
      border-color: rgba(248, 113, 113, 0.8);
      color: #fecaca;
    }

    /* å³ä¾§å†…å®¹åŒºåŸŸ */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 16px 20px 14px;
      overflow: hidden;
    }
    .top-header {
      height: 52px;
      background: #ffffff;
      border-radius: 10px;
      box-shadow: 0 1px 0 rgba(15,23,42,0.04);
      border: 1px solid rgba(226,232,240,0.9);
      padding: 0 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 14px;
    }
    .breadcrumb {
      font-size: 13px;
      color: #6b7280;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .breadcrumb span.current {
      color: #111827;
      font-weight: 500;
    }
    .header-user {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: #4b5563;
    }
    .header-avatar {
      width: 26px;
      height: 26px;
      border-radius: 999px;
      background: #e5edff;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #1d4ed8;
      font-weight: 600;
      font-size: 13px;
    }
    .top-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 14px;
    }
    .top-title {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .top-title h1 {
      font-size: 19px;
      font-weight: 600;
      color: #111827;
      letter-spacing: 0.01em;
    }
    .top-subtitle {
      font-size: 12px;
      color: #6b7280;
    }
    .top-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .btn {
      padding: 7px 13px;
      border-radius: 999px;
      border: 1px solid transparent;
      cursor: pointer;
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: transparent;
      color: #111827;
      transition: all 0.15s ease;
    }
    .btn-primary {
      background: linear-gradient(135deg, #2563eb, #4f46e5);
      color: #f9fafb;
      border-color: transparent;
      box-shadow: 0 10px 30px rgba(37, 99, 235, 0.28);
    }
    .btn-primary:hover {
      box-shadow: 0 14px 40px rgba(37, 99, 235, 0.36);
      transform: translateY(-0.5px);
    }
    .btn-ghost {
      border-color: rgba(148, 163, 184, 0.5);
      color: #374151;
      background: rgba(255, 255, 255, 0.8);
    }
    .btn-ghost:hover {
      border-color: #4f46e5;
      color: #111827;
      box-shadow: 0 6px 18px rgba(148, 163, 184, 0.35);
      transform: translateY(-0.5px);
    }

    /* é¡¶éƒ¨ç»Ÿè®¡å¡ç‰‡ */
    .stat-row {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 10px;
      margin-bottom: 14px;
    }
    .stat-card {
      background: rgba(255, 255, 255, 0.9);
      border-radius: 10px;
      padding: 10px 11px;
      border: 1px solid rgba(226, 232, 240, 0.9);
      box-shadow: 0 10px 30px rgba(15, 23, 42, 0.04);
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .stat-label {
      font-size: 11px;
      color: #6b7280;
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .stat-value {
      font-size: 19px;
      font-weight: 600;
      color: #111827;
    }
    .stat-trend {
      font-size: 11px;
      color: #16a34a;
    }

    /* ä¸»ç½‘æ ¼ */
    .main-grid {
      display: grid;
      grid-template-columns: 260px minmax(0, 1.7fr) 260px;
      gap: 12px;
      flex: 1;
      min-height: 0;
    }
    .panel {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 12px;
      box-shadow: 0 16px 40px rgba(15, 23, 42, 0.06);
      border: 1px solid rgba(226, 232, 240, 0.9);
      overflow: hidden;
      display: flex;
      flex-direction: column;
      backdrop-filter: blur(10px);
    }
    .panel-header {
      padding: 10px 13px;
      border-bottom: 1px solid rgba(229, 231, 235, 0.9);
      font-weight: 500;
      font-size: 13px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-shrink: 0;
      color: #111827;
    }
    .panel-header span.icon {
      margin-right: 6px;
    }
    .panel-subtitle {
      font-size: 11px;
      color: #9ca3af;
      margin-left: 4px;
    }
    .panel-body {
      padding: 11px 12px;
      overflow-y: auto;
      flex: 1;
      min-height: 0;
    }
    input {
      width: 100%;
      padding: 9px 11px;
      border: 1px solid rgba(209, 213, 219, 0.9);
      border-radius: 8px;
      font-size: 13px;
      background: #f9fafb;
    }
    input:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 1px rgba(37, 99, 235, 0.3);
      background: #ffffff;
    }
    .ds-item { padding: 8px 10px; border: 1px solid #eee; border-radius: 6px; margin-bottom: 6px; cursor: pointer; }
    .ds-item:hover { border-color: #667eea; }
    .ds-item.active { border-color: #667eea; background: #f8f9ff; }
    .ds-item .name { font-weight: 500; font-size: 13px; }
    .ds-item .type { font-size: 10px; color: #888; margin-top: 2px; }
    .left-col { display: flex; flex-direction: column; min-height: 0; }
    .chat-container { display: flex; flex-direction: column; min-height: 0; }
    .chat-messages { flex: 1; overflow-y: auto; padding: 14px; background: radial-gradient(circle at top left, #f9fafb 0, #f3f4f6 45%, #eef2ff 100%); min-height: 0; }
    .message { margin-bottom: 16px; }
    .message.user { text-align: right; }
    .message .bubble { display: inline-block; max-width: 85%; padding: 12px 16px; border-radius: 12px; text-align: left; }
    .message.user .bubble { background: #667eea; color: white; }
    .message.ai .bubble { background: white; border: 1px solid #eee; }
    .message.ai .bubble h1, .message.ai .bubble h2, .message.ai .bubble h3 { font-size: 15px; margin: 10px 0 5px; color: #333; }
    .message.ai .bubble p { margin: 8px 0; line-height: 1.6; }
    .message.ai .bubble ul, .message.ai .bubble ol { margin: 8px 0; padding-left: 20px; }
    .message.ai .bubble li { margin: 4px 0; }
    .message.ai .bubble strong { color: #667eea; }
    .message.ai .bubble code { background: #f0f2f5; padding: 2px 6px; border-radius: 4px; font-size: 13px; }
    .message.ai .bubble table { width: 100%; border-collapse: collapse; margin: 10px 0; font-size: 13px; }
    .message.ai .bubble table th, .message.ai .bubble table td { padding: 6px 10px; border: 1px solid #eee; text-align: left; }
    .message.ai .bubble table th { background: #f8f9fa; }
    .message .sql { background: #2d3748; color: #a0aec0; padding: 10px; border-radius: 6px; margin-top: 10px; font-family: monospace; font-size: 12px; white-space: pre-wrap; }
    .message .data-table { margin-top: 10px; overflow-x: auto; }
    .message table { width: 100%; border-collapse: collapse; font-size: 12px; }
    .message th, .message td { padding: 6px 8px; border: 1px solid #eee; text-align: left; }
    .message th { background: #f8f9fa; }
    .chat-input { display: flex; gap: 8px; padding: 9px 11px; border-top: 1px solid rgba(229, 231, 235, 0.9); background: rgba(255, 255, 255, 0.96); flex-shrink: 0; }
    .chat-input input { flex: 1; padding: 8px 10px; font-size: 13px; }
    .history-item { padding: 8px 10px; border-radius: 5px; margin-bottom: 4px; cursor: pointer; font-size: 12px; color: #555; background: #f8f9fa; display: flex; justify-content: space-between; }
    .history-item:hover { background: #eef0f5; }
    .history-item.active { background: #e8ebf5; color: #667eea; }
    .history-item .preview { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .history-item .delete { opacity: 0; color: #e74c3c; font-size: 16px; }
    .history-item:hover .delete { opacity: 1; }
    .empty { text-align: center; padding: 20px; color: #999; font-size: 13px; }
    .new-chat-btn { width: 100%; margin-bottom: 8px; background: #f0f2f5; color: #333; border: 1px dashed #ccc; font-size: 12px; padding: 6px; }
    .new-chat-btn:hover { border-color: #667eea; color: #667eea; }
    .schema-table { margin-bottom: 8px; border: 1px solid #eee; border-radius: 6px; overflow: hidden; }
    .schema-header { background: #f8f9fa; padding: 8px 10px; font-weight: 600; font-size: 12px; display: flex; justify-content: space-between; cursor: pointer; }
    .schema-header:hover { background: #f0f2f5; }
    .schema-header .cn { color: #667eea; font-weight: normal; margin-left: 8px; }
    .schema-body { display: none; }
    .schema-table.open .schema-body { display: block; }
    .schema-col { display: grid; grid-template-columns: 1fr 1fr 60px; padding: 6px 10px; border-top: 1px solid #eee; font-size: 11px; }
    .schema-col:hover { background: #fafbfc; }
    .schema-col .name { font-family: monospace; }
    .schema-col .cn { color: #667eea; }
    .schema-col .type { color: #888; text-align: right; }
    .schema-col .edit-btn { opacity: 0; cursor: pointer; color: #667eea; font-size: 10px; margin-left: 4px; }
    .schema-col:hover .edit-btn { opacity: 1; }
    .edit-input { padding: 2px 5px; border: 1px solid #667eea; border-radius: 3px; font-size: 11px; width: 70px; }
    .questions { padding: 12px; border-top: 1px solid #eee; }
    .questions h4 { font-size: 12px; color: #666; margin-bottom: 8px; }
    .q-tag { display: inline-block; padding: 5px 10px; margin: 2px; background: #f0f2f5; border-radius: 14px; font-size: 11px; color: #555; cursor: pointer; }
    .q-tag:hover { background: #667eea; color: white; }
    .analyze-btn { font-size: 11px; color: #667eea; background: #f0f2f5; border: none; cursor: pointer; padding: 3px 8px; border-radius: 4px; }
    .analyze-btn:hover { background: #667eea; color: white; }
    .chart-inline { width: 100%; height: 200px; margin: 10px 0; border-radius: 6px; background: #fafbfc; }
    .action-btns { display: flex; gap: 6px; margin-top: 8px; padding-top: 8px; border-top: 1px solid #eee; }
    .action-btns button { font-size: 11px; padding: 4px 10px; border: 1px solid #ddd; border-radius: 4px; background: white; cursor: pointer; }
    .action-btns button:hover { border-color: #667eea; color: #667eea; }
    .dashboard-btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important; color: white !important; border: none !important; font-size: 12px !important; padding: 6px 12px !important; }
    .dashboard-btn:hover { opacity: 0.9; }
    .right-col { display: flex; flex-direction: column; min-height: 0; }
    .tag-pill {
      display: inline-flex;
      align-items: center;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.55);
      font-size: 11px;
      color: #4b5563;
      background: rgba(249, 250, 251, 0.9);
      gap: 4px;
    }
    .tag-pill-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: #22c55e;
      box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.2);
    }
  </style>
</head>

<body>
  <div class="app-shell">
    <!-- å·¦ä¾§å¯¼èˆª -->
    <aside class="sidebar">
      <div class="logo-row">
        <div class="logo-mark">A</div>
        <div>
          <div class="logo-text-main">AI æ•°æ®å¹³å°</div>
          <div class="logo-text-sub">AI Data Platform</div>
        </div>
      </div>

      <div class="nav-section-title">å¯¼èˆª</div>
      <ul class="nav-list">
        <li class="nav-item">
          <div class="nav-link active" onclick="location.href='/'">
            <div class="nav-link-left">
              <span class="nav-icon">ğŸ“Š</span>
              <span>ä»ªè¡¨ç›˜</span>
            </div>
          </div>
        </li>
        <li class="nav-item">
          <div class="nav-link" onclick="location.href='/datasource.html'">
            <div class="nav-link-left">
              <span class="nav-icon">ğŸ—„ï¸</span>
              <span>æ•°æ®æº</span>
            </div>
          </div>
        </li>
        <li class="nav-item">
          <div class="nav-link" onclick="location.href='/knowledge.html'">
            <div class="nav-link-left">
              <span class="nav-icon">ğŸ“š</span>
              <span>çŸ¥è¯†åº“ / RAG</span>
            </div>
          </div>
        </li>
        <li class="nav-item">
          <div class="nav-link" onclick="location.href='/chat.html'">
            <div class="nav-link-left">
              <span class="nav-icon">ğŸ’¬</span>
              <span>å¯¹è¯å†å²</span>
            </div>
          </div>
        </li>
        <li class="nav-item">
          <div class="nav-link" onclick="location.href='/admin.html'">
            <div class="nav-link-left">
              <span class="nav-icon">ğŸ‘¥</span>
              <span>ç”¨æˆ·ä¸æƒé™</span>
            </div>
          </div>
        </li>
      </ul>

      <div class="nav-footer">
        <div class="nav-footer-user">
          <div class="nav-footer-user-left">
            <div class="avatar" id="navAvatar">U</div>
            <div>
              <div id="navUserName">ç”¨æˆ·</div>
              <div style="font-size:10px;color:rgba(148,163,184,0.9)">å·²ç™»å½•</div>
            </div>
          </div>
          <div class="logout-link" onclick="logout()">é€€å‡º</div>
        </div>
      </div>
    </aside>

    <!-- å³ä¾§ä¸»å†…å®¹ -->
    <main class="main">
      <div class="top-header">
        <div class="breadcrumb">
          <span>é¦–é¡µ</span>
          <span>/</span>
          <span class="current">ä»ªè¡¨ç›˜</span>
        </div>
        <div class="header-user">
          <div class="header-avatar" id="headerAvatar">U</div>
          <span id="headerUserName">ç”¨æˆ·</span>
        </div>
      </div>
      <div class="top-bar">
        <div class="top-title">
          <h1>å¯¹è¯ä½ çš„æ•°æ®ä»“åº“</h1>
          <div class="top-subtitle">é€‰æ‹©æ•°æ®æºï¼Œæå‡ºä¸šåŠ¡é—®é¢˜ï¼ŒAI è‡ªåŠ¨ç”Ÿæˆ SQLã€å›¾è¡¨å’Œæ´å¯Ÿã€‚</div>
        </div>
        <div class="top-actions">
          <button class="btn btn-ghost" onclick="location.href='/datasource.html'">ğŸ—„ï¸ æŸ¥çœ‹æ•°æ®æº</button>
          <button class="btn btn-primary" onclick="openDashboard()">ğŸ“Š ä¸€é”®ç”Ÿæˆ BI å¤§å±</button>
        </div>
      </div>

      <div class="stat-row">
        <div class="stat-card">
          <div class="stat-label">åœ¨çº¿æ•°æ®æº</div>
          <div class="stat-value" id="stat-ds-count">-</div>
          <div class="stat-trend" id="stat-ds-tip">è¿æ¥ä½ çš„ MySQL / PostgreSQL / æ–‡ä»¶</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">ä»Šæ—¥å¯¹è¯</div>
          <div class="stat-value" id="stat-chat-count">-</div>
          <div class="stat-trend">æ”¯æŒè¿½é—®ã€ä¸Šä¸‹æ–‡è®°å¿†</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">çŸ¥è¯†åº“æ–‡æ¡£</div>
          <div class="stat-value" id="stat-kb-count">-</div>
          <div class="stat-trend">å¯ä¸ç»“æ„åŒ–æ•°æ®æ··åˆæ£€ç´¢</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">å·²ç”ŸæˆæŠ¥è¡¨</div>
          <div class="stat-value" id="stat-report-count">-</div>
          <div class="stat-trend">ä¸€é”®å¯¼å‡º PPT / æ•°æ®æŠ¥å‘Š</div>
        </div>
      </div>

      <div class="main-grid">
      <!-- å·¦ä¾§ï¼šæ•°æ®æºå’Œæ•°æ®ç»“æ„ -->
      <div class="left-col">
        <div class="panel" style="margin-bottom:10px;flex-shrink:0;max-height:180px">
          <div class="panel-header">
            <div><span class="icon">ğŸ—„ï¸</span>æ•°æ®æº</div>
            <a href="/datasource.html" style="font-size:11px;color:#4f46e5;text-decoration:none">ç®¡ç†</a>
          </div>
          <div class="panel-body" id="ds-list"><div class="empty">æš‚æ— æ•°æ®æº</div></div>
        </div>
        <div class="panel" id="schema-panel" style="display:none;flex:1;min-height:0">
          <div class="panel-header">
            <div><span class="icon">ğŸ“‘</span>æ•°æ®ç»“æ„<span class="panel-subtitle">å­—æ®µå«ä¹‰ã€ä¸»é”®ã€æŒ‡æ ‡</span></div>
            <button class="analyze-btn" id="analyze-btn" onclick="analyzeSchema()">ğŸ” AI åˆ†æ</button>
          </div>
          <div class="panel-body" id="schema-content"></div>
        </div>
      </div>
      <!-- ä¸­é—´ï¼šå¯¹è¯åŒºåŸŸ -->
      <div class="panel chat-container">
        <div class="panel-header">
          <div><span class="icon">ğŸ’¬</span>è‡ªç„¶è¯­è¨€é—®æ•°ä»“<span class="panel-subtitle">æ”¯æŒè¿½é—®ã€ä¸Šä¸‹æ–‡è®°å¿†ã€å›¾è¡¨ç”Ÿæˆ</span></div>
        </div>
        <div class="chat-messages" id="messages"><div class="empty">åœ¨å·¦ä¾§é€‰æ‹©æ•°æ®æºåï¼Œå¼€å§‹å‘ AI æé—®ä½ çš„ä¸šåŠ¡é—®é¢˜ã€‚</div></div>
        <div class="chat-input">
          <input type="text" id="input" placeholder="ä¾‹å¦‚ï¼šæŒ‰æœˆæŸ¥çœ‹è¿‘ 12 ä¸ªæœˆçš„è®¢å•é‡‘é¢è¶‹åŠ¿" onkeypress="if(event.key==='Enter')ask()">
          <button class="btn btn-primary" onclick="ask()">å‘é€</button>
        </div>
      </div>

      <!-- å³ä¾§ï¼šå†å²å¯¹è¯å’Œæ¨èé—®é¢˜ -->
      <div id="right-panel" class="right-col" style="display:none">
        <div class="panel" style="margin-bottom:10px;flex-shrink:0;max-height:200px">
          <div class="panel-header">ğŸ“œ å†å²å¯¹è¯ <button class="btn new-chat-btn" onclick="newChat()" style="font-size:11px;padding:3px 6px;width:auto">+ æ–°å¯¹è¯</button></div>
          <div class="panel-body" id="history-list"></div>
        </div>
        <div class="panel" id="questions-panel" style="display:none;flex:1;min-height:0">
          <div class="panel-header">ğŸ’¡ æ¨èé—®é¢˜</div>
          <div class="panel-body" id="q-list"></div>
        </div>
      </div>
    </div>
    </main>
  </div>

<script>
function checkAuth() {
  const token = localStorage.getItem('authToken');
  if (!token) { window.location.href = '/login.html'; return false; }
  const user = JSON.parse(localStorage.getItem('user') || '{}');
  const name = user.fullName || user.username || 'ç”¨æˆ·';

  const headerNameEl = document.getElementById('headerUserName');
  const headerAvatarEl = document.getElementById('headerAvatar');
  const navNameEl = document.getElementById('navUserName');
  const navAvatarEl = document.getElementById('navAvatar');

  if (headerNameEl) headerNameEl.textContent = name;
  if (navNameEl) navNameEl.textContent = name;
  const initial = String(name).charAt(0).toUpperCase();
  if (headerAvatarEl) headerAvatarEl.textContent = initial;
  if (navAvatarEl) navAvatarEl.textContent = initial;

  return true;
}
function logout() { localStorage.removeItem('authToken'); localStorage.removeItem('user'); window.location.href = '/login.html'; }
function getAuthHeaders() { return { 'Authorization': 'Bearer ' + localStorage.getItem('authToken'), 'Content-Type': 'application/json' }; }
if (!checkAuth()) throw new Error('æœªç™»å½•');

let ds=null,sid=null,dsList=[],schemaData=null,analysisData=null;
async function load(){
  try {
    const res = await fetch('/api/datasource', { headers: getAuthHeaders() });
    if (res.status === 401) { logout(); return; }
    dsList = await res.json();
    renderDS();
  } catch(e) { console.error(e); }
}
function renderDS(){const c=document.getElementById('ds-list');if(!dsList.length){c.innerHTML='<div class="empty">æš‚æ— ï¼Œ<a href="/datasource.html">å»æ·»åŠ </a></div>';return;}c.innerHTML=dsList.map(d=>`<div class="ds-item ${ds?.id===d.id?'active':''}" onclick="selDS('${d.id}')"><div class="name">${esc(d.name)}</div><div class="type">${d.type.toUpperCase()}</div></div>`).join('');}
async function selDS(id){
  ds=dsList.find(d=>d.id===id);sid=null;schemaData=null;analysisData=null;renderDS();
  document.getElementById('right-panel').style.display='flex';
  document.getElementById('schema-panel').style.display='flex';
  document.getElementById('analyze-btn').textContent='ğŸ” AIåˆ†æ';
  loadSchema();await loadCachedAnalysis();await loadHistoryAndOpenLatest();
}
async function loadCachedAnalysis(){
  if(!ds)return;
  try{
    const res=await fetch('/api/datasource/'+ds.id+'/schema/analyze',{headers:getAuthHeaders()});
    if(res.status===401){logout();return;}
    const r=await res.json();
    if(r.cached || r.tables?.length){
      analysisData=r;renderSchema();
      if(r.suggestedQuestions?.length){
        document.getElementById('questions-panel').style.display='flex';
        document.getElementById('q-list').innerHTML=r.suggestedQuestions.map(q=>`<span class="q-tag" onclick="askQ(this.textContent)">${esc(q)}</span>`).join('');
      }
      document.getElementById('analyze-btn').textContent=r.cached?'âœ“ å·²ç¼“å­˜':'âœ“ å·²åˆ†æ';
    }else{document.getElementById('questions-panel').style.display='none';}
  }catch(e){document.getElementById('questions-panel').style.display='none';}
}
async function loadHistoryAndOpenLatest(){
  if(!ds)return;
  const res=await fetch('/api/chat/sessions/'+ds.id,{headers:getAuthHeaders()});
  if(res.status===401){logout();return;}
  const s=await res.json();
  document.getElementById('history-list').innerHTML=s.length?s.map(x=>`<div class="history-item ${sid===x.id?'active':''}" onclick="loadSess('${x.id}')"><span class="preview">${esc(x.preview)}...</span><span class="delete" onclick="event.stopPropagation();delSess('${x.id}')">&times;</span></div>`).join(''):'<div style="color:#999;font-size:12px;text-align:center">æš‚æ— å†å²</div>';
  if(s.length>0){await loadSess(s[0].id);}else{document.getElementById('messages').innerHTML='<div class="empty">å¼€å§‹æé—®å§ï¼</div>';}
}
async function loadSchema(){const c=document.getElementById('schema-content');c.innerHTML='<div class="empty">åŠ è½½ä¸­...</div>';try{const res=await fetch('/api/datasource/'+ds.id+'/schema',{headers:getAuthHeaders()});if(res.status===401){logout();return;}schemaData=await res.json();analysisData=null;renderSchema();}catch{c.innerHTML='<div class="empty">åŠ è½½å¤±è´¥</div>';}}
function renderSchema(){
  const analysis = analysisData;
  document.getElementById('schema-content').innerHTML=schemaData.map((t,i)=>{
    const ta=analysis?.tables?.find(x=>x.tableName===t.tableName);
    return`<div class="schema-table ${i===0?'open':''}" onclick="this.classList.toggle('open')">
      <div class="schema-header"><span>ğŸ“‹ ${t.tableName}${ta?.tableNameCn?`<span class="cn" ondblclick="event.stopPropagation();editTableName('${t.tableName}',this)">${ta.tableNameCn}</span>`:''}</span><span style="color:#888;font-size:11px">${t.columns.length}å­—æ®µ</span></div>
      <div class="schema-body" onclick="event.stopPropagation()">${t.columns.map(col=>{const ca=ta?.columns?.find(x=>x.name===col.name);return`<div class="schema-col"><span class="name">${col.name}</span><span class="cn" ondblclick="editColName('${t.tableName}','${col.name}',this)">${ca?.nameCn||'-'}<span class="edit-btn">âœï¸</span></span><span class="type">${col.type}</span></div>`;}).join('')}</div></div>`;
  }).join('');
}

async function analyzeSchema(){if(!ds)return;const btn=document.getElementById('analyze-btn');btn.textContent='åˆ†æä¸­...';btn.disabled=true;try{const res=await fetch('/api/datasource/'+ds.id+'/schema/analyze',{headers:getAuthHeaders()});if(res.status===401){logout();return;}const r=await res.json();analysisData=r;renderSchema();if(r.suggestedQuestions?.length){document.getElementById('questions-panel').style.display='block';document.getElementById('q-list').innerHTML=r.suggestedQuestions.map(q=>`<span class="q-tag" onclick="askQ(this.textContent)">${esc(q)}</span>`).join('');}btn.textContent=r.cached?'âœ“ å·²ç¼“å­˜':'âœ“ å·²åˆ†æ';}catch(e){btn.textContent='åˆ†æå¤±è´¥';console.error(e);}btn.disabled=false;}
function editTableName(tableName,el){const oldVal=el.textContent;el.innerHTML=`<input class="edit-input" value="${esc(oldVal)}" onblur="saveTableName('${tableName}',this)" onkeypress="if(event.key==='Enter')this.blur()">`;el.querySelector('input').focus();}
async function saveTableName(tableName,inp){const newVal=inp.value.trim();if(!newVal){inp.parentElement.textContent=inp.defaultValue;return;}try{await fetch(`/api/datasource/${ds.id}/schema/table/${tableName}`,{method:'PUT',headers:getAuthHeaders(),body:JSON.stringify({tableNameCn:newVal})});if(analysisData){const t=analysisData.tables?.find(x=>x.tableName===tableName);if(t)t.tableNameCn=newVal;}inp.parentElement.textContent=newVal;}catch{inp.parentElement.textContent=inp.defaultValue;}}
function editColName(tableName,colName,el){const oldVal=el.textContent.replace('âœï¸','').trim();el.innerHTML=`<input class="edit-input" value="${oldVal==='-'?'':esc(oldVal)}" onblur="saveColName('${tableName}','${colName}',this)" onkeypress="if(event.key==='Enter')this.blur()">`;el.querySelector('input').focus();}
async function saveColName(tableName,colName,inp){const newVal=inp.value.trim()||'-';try{await fetch(`/api/datasource/${ds.id}/schema/table/${tableName}/column/${colName}`,{method:'PUT',headers:getAuthHeaders(),body:JSON.stringify({nameCn:newVal==='-'?'':newVal})});if(analysisData){const t=analysisData.tables?.find(x=>x.tableName===tableName);const c=t?.columns?.find(x=>x.name===colName);if(c)c.nameCn=newVal==='-'?'':newVal;}inp.parentElement.innerHTML=`${newVal}<span class="edit-btn">âœï¸</span>`;}catch{inp.parentElement.innerHTML=`${inp.defaultValue||'-'}<span class="edit-btn">âœï¸</span>`;}}
function askQ(q){document.getElementById('input').value=q;ask();}
async function loadHistory(){if(!ds)return;const res=await fetch('/api/chat/sessions/'+ds.id,{headers:getAuthHeaders()});if(res.status===401){logout();return;}const s=await res.json();document.getElementById('history-list').innerHTML=s.length?s.map(x=>`<div class="history-item ${sid===x.id?'active':''}" onclick="loadSess('${x.id}')"><span class="preview">${esc(x.preview)}...</span><span class="delete" onclick="event.stopPropagation();delSess('${x.id}')">&times;</span></div>`).join(''):'<div style="color:#999;font-size:12px;text-align:center">æš‚æ— </div>';}
function newChat(){sid=null;document.getElementById('messages').innerHTML='<div class="empty">å¼€å§‹æ–°å¯¹è¯å§ï¼</div>';loadHistory();}
async function loadSess(id){sid=id;const res=await fetch('/api/chat/session/'+id,{headers:getAuthHeaders()});if(res.status===401){logout();return;}const s=await res.json();renderMsgs(s.messages);loadHistory();}
async function delSess(id){if(!confirm('ç¡®å®šåˆ é™¤ï¼Ÿ'))return;await fetch('/api/chat/session/'+id,{method:'DELETE',headers:getAuthHeaders()});sid===id?newChat():loadHistory();}
function renderMsgs(msgs){const c=document.getElementById('messages');if(!msgs?.length){c.innerHTML='<div class="empty">å¼€å§‹æé—®å§ï¼</div>';return;}c.innerHTML=msgs.map(m=>m.role==='user'?`<div class="message user"><div class="bubble">${esc(m.content)}</div></div>`:`<div class="message ai"><div class="bubble"><div class="md-content">${renderMd(m.content)}</div>${m.sql?`<div class="sql">${esc(m.sql)}</div>`:''}</div></div>`).join('');c.scrollTop=c.scrollHeight;}
function renderMd(text){try{return marked.parse(text||'');}catch{return esc(text);}}

function renderChart(chart){
  const containers=document.querySelectorAll('.chart-inline');
  const container=containers[containers.length-1];
  if(!container||!chart)return;
  const ec=echarts.init(container);
  let option={};
  const {type,data,config,title}=chart;
  if(type==='pie'){
    option={title:{text:title,left:'center',textStyle:{fontSize:14}},tooltip:{trigger:'item'},series:[{type:'pie',radius:['40%','70%'],data:data.map(d=>({name:d[config.labelField||config.xField],value:d[config.valueField||config.yField]}))}]};
  }else if(type==='line'||type==='area'){
    option={title:{text:title,left:'center',textStyle:{fontSize:14}},tooltip:{trigger:'axis'},xAxis:{type:'category',data:data.map(d=>d[config.xField])},yAxis:{type:'value'},series:[{type:'line',data:data.map(d=>d[config.yField]),smooth:true,areaStyle:type==='area'?{}:undefined}]};
  }else{
    option={title:{text:title,left:'center',textStyle:{fontSize:14}},tooltip:{trigger:'axis'},xAxis:{type:'category',data:data.map(d=>d[config.xField]),axisLabel:{rotate:data.length>8?45:0}},yAxis:{type:'value'},series:[{type:'bar',data:data.map(d=>d[config.yField]),itemStyle:{color:'#667eea'}}]};
  }
  ec.setOption(option);
  window.addEventListener('resize',()=>ec.resize());
}
function openDashboard(){if(!ds){alert('è¯·å…ˆé€‰æ‹©æ•°æ®æº');return;}const topic=prompt('è¯·è¾“å…¥å¤§å±ä¸»é¢˜ï¼ˆå¦‚ï¼šäººå£åˆ†æã€é”€å”®æ¦‚è§ˆï¼‰');if(!topic)return;window.open(`/api/agent/dashboard/preview?datasourceId=${ds.id}&topic=${encodeURIComponent(topic)}&theme=dark`,'_blank');}
function genDashboardFromQ(q){if(!ds)return;window.open(`/api/agent/dashboard/preview?datasourceId=${ds.id}&topic=${encodeURIComponent(q)}&theme=dark`,'_blank');}
function copyAnswer(btn){const bubble=btn.closest('.bubble');const text=bubble.querySelector('.md-content')?.innerText||'';navigator.clipboard.writeText(text).then(()=>{btn.textContent='âœ“ å·²å¤åˆ¶';setTimeout(()=>btn.textContent='ğŸ“‹ å¤åˆ¶',1500);});}
async function ask(){const inp=document.getElementById('input'),q=inp.value.trim();if(!q||!ds)return;inp.value='';const c=document.getElementById('messages');if(c.querySelector('.empty'))c.innerHTML='';c.innerHTML+=`<div class="message user"><div class="bubble">${esc(q)}</div></div><div class="message ai" id="loading"><div class="bubble">æ€è€ƒä¸­...</div></div>`;c.scrollTop=c.scrollHeight;try{const res=await fetch('/api/ask',{method:'POST',headers:getAuthHeaders(),body:JSON.stringify({datasourceId:ds.id,question:q,sessionId:sid})});if(res.status===401){logout();return;}const r=await res.json();if(r.sessionId)sid=r.sessionId;document.getElementById('loading').remove();const answer=r.answer||r.error||'æ— æ³•è·å–å›ç­”';let h=`<div class="message ai"><div class="bubble"><div class="md-content">${renderMd(answer)}</div>`;if(r.sql)h+=`<div class="sql">${esc(r.sql)}</div>`;if(r.chart)h+=`<div class="chart-inline" id="chart_${Date.now()}"></div>`;if(r.data?.length)h+=renderTbl(r.data.slice(0,20));h+=`<div class="action-btns"><button onclick="genDashboardFromQ('${esc(q)}')">ğŸ“Š ç”Ÿæˆå¤§å±</button><button onclick="copyAnswer(this)">ğŸ“‹ å¤åˆ¶</button></div>`;c.innerHTML+=h+'</div></div>';if(r.chart)renderChart(r.chart);loadHistory();}catch(e){document.getElementById('loading').remove();c.innerHTML+=`<div class="message ai"><div class="bubble">è¯·æ±‚å¤±è´¥: ${esc(e.message||'æœªçŸ¥é”™è¯¯')}</div></div>`;}c.scrollTop=c.scrollHeight;}
function renderTbl(d){const k=Object.keys(d[0]);return`<div class="data-table"><table><thead><tr>${k.map(x=>`<th>${esc(x)}</th>`).join('')}</tr></thead><tbody>${d.map(r=>`<tr>${k.map(x=>`<td>${esc(String(r[x]??''))}</td>`).join('')}</tr>`).join('')}</tbody></table></div>`;}
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
load();
</script>
</body>
</html>