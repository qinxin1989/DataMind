<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç”¨æˆ·ç®¡ç† - AIæ•°æ®é—®ç­”å¹³å°</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f5f7fa; min-height: 100vh; }
    .container { max-width: 1000px; margin: 0 auto; padding: 20px; }
    header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
    header h1 { font-size: 22px; }
    header a { color: white; text-decoration: none; opacity: 0.9; margin-left: 15px; }
    .panel { background: white; border-radius: 12px; box-shadow: 0 2px 12px rgba(0,0,0,0.08); margin-bottom: 20px; }
    .panel-header { padding: 15px 20px; border-bottom: 1px solid #eee; font-weight: 600; display: flex; justify-content: space-between; align-items: center; }
    .panel-body { padding: 20px; }
    .btn { padding: 8px 16px; border: none; border-radius: 6px; cursor: pointer; font-size: 14px; }
    .btn-primary { background: #667eea; color: white; }
    .btn-success { background: #27ae60; color: white; }
    .btn-danger { background: #e74c3c; color: white; }
    .btn-outline { background: white; border: 1px solid #ddd; color: #666; }
    .btn:hover { opacity: 0.9; }
    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    input, select { padding: 10px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; }
    input:focus, select:focus { outline: none; border-color: #667eea; }
    label { display: block; margin-bottom: 5px; font-size: 13px; color: #666; }
    .form-group { margin-bottom: 15px; }
    .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #eee; }
    th { background: #f8f9fa; font-weight: 600; font-size: 13px; color: #666; }
    .status { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 12px; }
    .status-active { background: #d4edda; color: #155724; }
    .status-pending { background: #fff3cd; color: #856404; }
    .status-inactive { background: #f8d7da; color: #721c24; }
    .role { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 12px; }
    .role-admin { background: #e8daef; color: #6c3483; }
    .role-user { background: #d6eaf8; color: #2874a6; }
    .empty { text-align: center; padding: 40px; color: #999; }
    .toast { position: fixed; top: 20px; right: 20px; padding: 12px 20px; border-radius: 8px; color: white; font-size: 14px; z-index: 1000; }
    .toast-success { background: #27ae60; }
    .toast-error { background: #e74c3c; }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; }
    .modal.show { display: flex; align-items: center; justify-content: center; }
    .modal-content { background: white; padding: 30px; border-radius: 12px; width: 100%; max-width: 450px; }
    .modal-header { font-size: 18px; font-weight: 600; margin-bottom: 20px; }
    .actions { display: flex; gap: 8px; }
    .actions .btn { padding: 6px 12px; font-size: 12px; }
    .badge { background: #e74c3c; color: white; padding: 2px 8px; border-radius: 10px; font-size: 12px; margin-left: 8px; }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>ğŸ‘¥ ç”¨æˆ·ç®¡ç†</h1>
      <div>
        <span id="userDisplay" style="font-size:14px;opacity:0.9"></span>
        <a href="/">â† è¿”å›é¦–é¡µ</a>
        <a href="#" onclick="logout()">é€€å‡º</a>
      </div>
    </header>

    <!-- å¾…å®¡æ ¸ç”¨æˆ· -->
    <div class="panel" id="pendingPanel">
      <div class="panel-header">
        <span>å¾…å®¡æ ¸ç”¨æˆ· <span class="badge" id="pendingCount">0</span></span>
      </div>
      <div class="panel-body">
        <table id="pendingTable">
          <thead>
            <tr><th>ç”¨æˆ·å</th><th>å§“å</th><th>é‚®ç®±</th><th>æ³¨å†Œæ—¶é—´</th><th>æ“ä½œ</th></tr>
          </thead>
          <tbody id="pendingBody"></tbody>
        </table>
      </div>
    </div>

    <!-- æ‰€æœ‰ç”¨æˆ· -->
    <div class="panel">
      <div class="panel-header">
        <span>æ‰€æœ‰ç”¨æˆ·</span>
        <button class="btn btn-primary" onclick="showAddModal()">+ æ–°å¢ç”¨æˆ·</button>
      </div>
      <div class="panel-body">
        <table>
          <thead>
            <tr><th>ç”¨æˆ·å</th><th>å§“å</th><th>é‚®ç®±</th><th>è§’è‰²</th><th>çŠ¶æ€</th><th>æ“ä½œ</th></tr>
          </thead>
          <tbody id="userBody"></tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- æ–°å¢ç”¨æˆ·å¼¹çª— -->
  <div class="modal" id="addModal">
    <div class="modal-content">
      <div class="modal-header">æ–°å¢ç”¨æˆ·</div>
      <div class="form-row">
        <div class="form-group">
          <label>ç”¨æˆ·å *</label>
          <input type="text" id="newUsername" style="width:100%">
        </div>
        <div class="form-group">
          <label>å¯†ç  *</label>
          <input type="password" id="newPassword" style="width:100%">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>å§“å</label>
          <input type="text" id="newFullName" style="width:100%">
        </div>
        <div class="form-group">
          <label>é‚®ç®±</label>
          <input type="email" id="newEmail" style="width:100%">
        </div>
      </div>
      <div class="form-group">
        <label>è§’è‰²</label>
        <select id="newRole" style="width:100%">
          <option value="user">æ™®é€šç”¨æˆ·</option>
          <option value="admin">ç®¡ç†å‘˜</option>
        </select>
      </div>
      <div style="display:flex;gap:10px;margin-top:20px">
        <button class="btn btn-primary" onclick="createUser()">åˆ›å»º</button>
        <button class="btn btn-outline" onclick="hideAddModal()">å–æ¶ˆ</button>
      </div>
    </div>
  </div>

  <script>
    function checkAuth() {
      const token = localStorage.getItem('authToken');
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      if (!token || user.role !== 'admin') {
        alert('éœ€è¦ç®¡ç†å‘˜æƒé™');
        window.location.href = '/';
        return false;
      }
      document.getElementById('userDisplay').textContent = 'ğŸ‘¤ ' + (user.fullName || user.username);
      return true;
    }

    function logout() {
      localStorage.removeItem('authToken');
      localStorage.removeItem('user');
      window.location.href = '/login.html';
    }

    function getAuthHeaders() {
      return { 'Authorization': 'Bearer ' + localStorage.getItem('authToken'), 'Content-Type': 'application/json' };
    }

    if (!checkAuth()) throw new Error('æ— æƒé™');

    async function loadPendingUsers() {
      try {
        const res = await fetch('/api/auth/users/pending', { headers: getAuthHeaders() });
        if (res.status === 401) { logout(); return; }
        const users = await res.json();
        document.getElementById('pendingCount').textContent = users.length;
        document.getElementById('pendingPanel').style.display = users.length ? 'block' : 'none';
        document.getElementById('pendingBody').innerHTML = users.map(u => `
          <tr>
            <td>${esc(u.username)}</td>
            <td>${esc(u.fullName || '-')}</td>
            <td>${esc(u.email || '-')}</td>
            <td>${new Date(u.createdAt).toLocaleString()}</td>
            <td class="actions">
              <button class="btn btn-success" onclick="approveUser('${u.id}')">é€šè¿‡</button>
              <button class="btn btn-danger" onclick="rejectUser('${u.id}')">æ‹’ç»</button>
            </td>
          </tr>
        `).join('');
      } catch (e) { console.error(e); }
    }

    async function loadAllUsers() {
      try {
        const res = await fetch('/api/auth/users', { headers: getAuthHeaders() });
        if (res.status === 401) { logout(); return; }
        const users = await res.json();
        document.getElementById('userBody').innerHTML = users.map(u => `
          <tr>
            <td>${esc(u.username)}</td>
            <td>${esc(u.fullName || '-')}</td>
            <td>${esc(u.email || '-')}</td>
            <td><span class="role role-${u.role}">${u.role === 'admin' ? 'ç®¡ç†å‘˜' : 'ç”¨æˆ·'}</span></td>
            <td><span class="status status-${u.status}">${statusText(u.status)}</span></td>
            <td class="actions">
              ${u.username !== 'admin' ? `<button class="btn btn-danger" onclick="deleteUser('${u.id}')">åˆ é™¤</button>` : ''}
            </td>
          </tr>
        `).join('');
      } catch (e) { console.error(e); }
    }

    function statusText(s) {
      return { active: 'æ­£å¸¸', pending: 'å¾…å®¡æ ¸', inactive: 'å·²ç¦ç”¨', suspended: 'å·²æš‚åœ' }[s] || s;
    }

    async function approveUser(id) {
      if (!confirm('ç¡®å®šé€šè¿‡è¯¥ç”¨æˆ·ï¼Ÿ')) return;
      try {
        const res = await fetch(`/api/auth/users/${id}/approve`, { method: 'POST', headers: getAuthHeaders() });
        if (res.ok) { toast('å·²é€šè¿‡', 'success'); loadPendingUsers(); loadAllUsers(); }
        else { const d = await res.json(); toast(d.error, 'error'); }
      } catch { toast('æ“ä½œå¤±è´¥', 'error'); }
    }

    async function rejectUser(id) {
      if (!confirm('ç¡®å®šæ‹’ç»è¯¥ç”¨æˆ·ï¼Ÿ')) return;
      try {
        const res = await fetch(`/api/auth/users/${id}/reject`, { method: 'POST', headers: getAuthHeaders() });
        if (res.ok) { toast('å·²æ‹’ç»', 'success'); loadPendingUsers(); }
        else { const d = await res.json(); toast(d.error, 'error'); }
      } catch { toast('æ“ä½œå¤±è´¥', 'error'); }
    }

    async function deleteUser(id) {
      if (!confirm('ç¡®å®šåˆ é™¤è¯¥ç”¨æˆ·ï¼Ÿ')) return;
      try {
        const res = await fetch(`/api/auth/users/${id}`, { method: 'DELETE', headers: getAuthHeaders() });
        if (res.ok) { toast('å·²åˆ é™¤', 'success'); loadAllUsers(); }
        else { const d = await res.json(); toast(d.error, 'error'); }
      } catch { toast('æ“ä½œå¤±è´¥', 'error'); }
    }

    function showAddModal() { document.getElementById('addModal').classList.add('show'); }
    function hideAddModal() { document.getElementById('addModal').classList.remove('show'); }

    async function createUser() {
      const username = document.getElementById('newUsername').value.trim();
      const password = document.getElementById('newPassword').value;
      const fullName = document.getElementById('newFullName').value.trim();
      const email = document.getElementById('newEmail').value.trim();
      const role = document.getElementById('newRole').value;

      if (!username || !password) { toast('è¯·å¡«å†™ç”¨æˆ·åå’Œå¯†ç ', 'error'); return; }

      try {
        const res = await fetch('/api/auth/users', {
          method: 'POST',
          headers: getAuthHeaders(),
          body: JSON.stringify({ username, password, role, email: email || undefined, fullName: fullName || undefined })
        });
        const data = await res.json();
        if (res.ok) {
          toast('åˆ›å»ºæˆåŠŸ', 'success');
          hideAddModal();
          document.getElementById('newUsername').value = '';
          document.getElementById('newPassword').value = '';
          document.getElementById('newFullName').value = '';
          document.getElementById('newEmail').value = '';
          loadAllUsers();
        } else {
          toast(data.error, 'error');
        }
      } catch { toast('åˆ›å»ºå¤±è´¥', 'error'); }
    }

    function toast(msg, type) {
      const div = document.createElement('div');
      div.className = `toast toast-${type}`;
      div.textContent = msg;
      document.body.appendChild(div);
      setTimeout(() => div.remove(), 3000);
    }

    function esc(s) { return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    loadPendingUsers();
    loadAllUsers();
  </script>
</body>
</html>
