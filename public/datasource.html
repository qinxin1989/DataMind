<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>æ•°æ®æºç®¡ç† - AI æ•°æ®å¹³å°</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f5f7fb;
      min-height: 100vh;
    }
    a { text-decoration: none; color: inherit; }
    .app-shell {
      height: 100vh;
      display: flex;
      background: #f5f7fb;
    }
    /* ä¾§è¾¹å¯¼èˆªï¼Œç¡…åŸºæµåŠ¨é£æ ¼ */
    .sidebar {
      width: 230px;
      background: #020617;
      background: linear-gradient(180deg,#020617 0,#020617 40%,#020617 100%);
      color: #e5edf7;
      display: flex;
      flex-direction: column;
      padding: 14px 12px;
      box-shadow: 1px 0 0 rgba(15, 23, 42, 0.7);
    }
    .logo-row {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 8px 14px;
      border-bottom: 1px solid rgba(148, 163, 184, 0.2);
      margin-bottom: 10px;
    }
    .logo-mark {
      width: 26px;
      height: 26px;
      border-radius: 8px;
      background: linear-gradient(135deg,#4f46e5,#8b5cf6);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 15px;
      color: #f9fafb;
    }
    .logo-text-main {
      font-size: 15px;
      font-weight: 600;
    }
    .logo-text-sub {
      font-size: 11px;
      color: rgba(148,163,184,0.9);
    }
    .nav-section-title {
      font-size: 11px;
      text-transform: uppercase;
      color: rgba(148, 163, 184, 0.8);
      padding: 8px 8px 4px;
      letter-spacing: 0.08em;
    }
    .nav-list { list-style:none; margin-top:4px; }
    .nav-item { border-radius:6px; margin-bottom:2px; }
    .nav-link {
      display:flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      font-size:13px;
      border-radius:6px;
      cursor:pointer;
      color:#d0e2ff;
      transition:all .15s ease;
    }
    .nav-icon { width:18px; text-align:center; }
    .nav-link:hover { background:rgba(59,130,246,0.25); }
    .nav-link.active {
      background:rgba(59,130,246,0.9);
      color:#f9fafb;
    }
    .nav-footer {
      margin-top:auto;
      padding:10px 6px 4px;
      border-top:1px solid rgba(148,163,184,0.2);
      font-size:11px;
      color:rgba(148,163,184,0.85);
    }
    .nav-footer-user {
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:4px;
    }
    .nav-footer-user-left {
      display:flex;
      align-items:center;
      gap:6px;
    }
    .avatar {
      width:22px;
      height:22px;
      border-radius:999px;
      background:#e5edff;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#1d4ed8;
      font-size:11px;
      font-weight:600;
    }
    .logout-link {
      cursor:pointer;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,0.6);
      color:#e5edf7;
    }
    .logout-link:hover {
      background:rgba(239,68,68,0.15);
      border-color:rgba(248,113,113,0.9);
      color:#fee2e2;
    }

    /* ä¸»åŒºåŸŸ */
    .main {
      flex:1;
      display:flex;
      flex-direction:column;
      padding:16px 20px 14px;
      overflow:hidden;
    }
    .top-header {
      height:52px;
      background:#ffffff;
      border-radius:10px;
      box-shadow:0 1px 0 rgba(15,23,42,0.04);
      border:1px solid rgba(226,232,240,0.9);
      padding:0 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:14px;
    }
    .breadcrumb {
      font-size:13px;
      color:#6b7280;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .breadcrumb span.current { color:#111827; font-weight:500; }
    .header-user {
      display:flex;
      align-items:center;
      gap:8px;
      font-size:13px;
      color:#4b5563;
    }
    .header-avatar {
      width:26px;
      height:26px;
      border-radius:999px;
      background:#e5edff;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#1d4ed8;
      font-weight:600;
      font-size:13px;
    }
    .page-title {
      font-size:18px;
      font-weight:600;
      margin-bottom:10px;
      color:#111827;
    }

    .panel {
      background:#ffffff;
      border-radius:12px;
      box-shadow:0 6px 20px rgba(15,23,42,0.06);
      border:1px solid rgba(226,232,240,0.9);
      margin-bottom:16px;
    }
    .panel-header {
      padding:12px 16px;
      border-bottom:1px solid #eee;
      font-weight:500;
      font-size:14px;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .panel-body { padding:16px 18px; }

    .btn { padding:8px 16px; border:none; border-radius:6px; cursor:pointer; font-size:13px; transition:all .2s; }
    .btn-primary { background:#2563eb; color:white; }
    .btn-primary:hover { background:#1d4ed8; }
    .btn-success { background:#16a34a; color:white; }
    .btn-success:hover { background:#15803d; }
    .btn-danger { background:#e11d48; color:white; }
    .btn-danger:hover { background:#be123c; }
    .btn-outline { background:white; border:1px solid #d1d5db; color:#4b5563; }
    .btn-outline:hover { border-color:#2563eb; color:#111827; }
    .btn:disabled { opacity:.6; cursor:not-allowed; }

    input, select, textarea {
      width:100%;
      padding:10px 12px;
      border:1px solid #d1d5db;
      border-radius:6px;
      font-size:14px;
    }
    input:focus, select:focus, textarea:focus {
      outline:none;
      border-color:#2563eb;
      box-shadow:0 0 0 1px rgba(37,99,235,0.25);
    }
    label { display:block; margin-bottom:5px; font-size:13px; color:#4b5563; font-weight:500; }
    .form-group { margin-bottom:15px; }
    .form-row { display:grid; grid-template-columns:1fr 1fr; gap:15px; }
    .ds-list { display:flex; flex-direction:column; gap:10px; }
    .ds-item { padding:15px; border:1px solid #e5e7eb; border-radius:8px; display:flex; justify-content:space-between; align-items:center; transition:all .15s; background:#f9fafb; }
    .ds-item:hover { border-color:#2563eb; box-shadow:0 4px 12px rgba(148,163,184,0.35); }
    .ds-info { flex:1; }
    .ds-info .name { font-weight:600; font-size:14px; margin-bottom:4px; }
    .ds-info .meta { font-size:12px; color:#6b7280; }
    .ds-actions { display:flex; gap:8px; }
    .ds-actions .btn { padding:6px 12px; font-size:12px; }
    .status { display:inline-block; padding:2px 8px; border-radius:10px; font-size:11px; }
    .status-success { background:#d1fae5; color:#166534; }
    .status-error { background:#fee2e2; color:#b91c1c; }
    .status-pending { background:#fef3c7; color:#92400e; }
    .empty { text-align:center; padding:40px; color:#9ca3af; }
    .toast { position:fixed; top:20px; right:20px; padding:12px 20px; border-radius:8px; color:white; font-size:14px; z-index:1000; animation:slideIn .3s; }
    .toast-success { background:#16a34a; }
    .toast-error { background:#e11d48; }
    @keyframes slideIn { from { transform:translateX(100%); opacity:0; } to { transform:translateX(0); opacity:1; } }
    .form-section { border:1px solid #e5e7eb; border-radius:8px; padding:15px; margin-top:15px; background:#f9fafb; }
    .form-section-title { font-size:13px; color:#6b7280; margin-bottom:12px; }
  </style>
</head>
<body>
  <div class="app-shell">
    <!-- ä¾§è¾¹å¯¼èˆª -->
    <aside class="sidebar">
      <div class="logo-row">
        <div class="logo-mark">A</div>
        <div>
          <div class="logo-text-main">AI æ•°æ®å¹³å°</div>
          <div class="logo-text-sub">AI Data Platform</div>
        </div>
      </div>

      <div class="nav-section-title">å¯¼èˆª</div>
      <ul class="nav-list">
        <li class="nav-item">
          <div class="nav-link" onclick="location.href='/'">
            <span class="nav-icon">ğŸ“Š</span><span>ä»ªè¡¨ç›˜</span>
          </div>
        </li>
        <li class="nav-item">
          <div class="nav-link active" onclick="location.href='/datasource.html'">
            <span class="nav-icon">ğŸ—„ï¸</span><span>æ•°æ®æº</span>
          </div>
        </li>
        <li class="nav-item">
          <div class="nav-link" onclick="location.href='/knowledge.html'">
            <span class="nav-icon">ğŸ“š</span><span>çŸ¥è¯†åº“ / RAG</span>
          </div>
        </li>
        <li class="nav-item">
          <div class="nav-link" onclick="location.href='/chat.html'">
            <span class="nav-icon">ğŸ’¬</span><span>å¯¹è¯å†å²</span>
          </div>
        </li>
        <li class="nav-item">
          <div class="nav-link" onclick="location.href='/admin.html'">
            <span class="nav-icon">ğŸ‘¥</span><span>ç”¨æˆ·ä¸æƒé™</span>
          </div>
        </li>
      </ul>

      <div class="nav-footer">
        <div class="nav-footer-user">
          <div class="nav-footer-user-left">
            <div class="avatar" id="navAvatar">U</div>
            <div>
              <div id="navUserName">ç”¨æˆ·</div>
            </div>
          </div>
          <div class="logout-link" onclick="logout()">é€€å‡º</div>
        </div>
      </div>
    </aside>

    <!-- ä¸»å†…å®¹ -->
    <main class="main">
      <div class="top-header">
        <div class="breadcrumb">
          <span>é¦–é¡µ</span><span>/</span><span class="current">æ•°æ®æºç®¡ç†</span>
        </div>
        <div class="header-user">
          <div class="header-avatar" id="headerAvatar">U</div>
          <span id="headerUserName">ç”¨æˆ·</span>
        </div>
      </div>

      <div class="page-title">æ•°æ®æºç®¡ç†</div>

      <!-- æ•°æ®æºåˆ—è¡¨ -->
      <div class="panel">
        <div class="panel-header">
          <span>å·²é…ç½®çš„æ•°æ®æº</span>
          <button class="btn btn-primary" onclick="showForm()">+ æ–°å¢æ•°æ®æº</button>
        </div>
        <div class="panel-body">
          <div class="ds-list" id="ds-list">
            <div class="empty">æš‚æ— æ•°æ®æºï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ </div>
          </div>
        </div>
      </div>

      <!-- æ–°å¢/ç¼–è¾‘è¡¨å• -->
      <div class="panel" id="form-panel" style="display:none">
        <div class="panel-header">
          <span id="form-title">æ–°å¢æ•°æ®æº</span>
          <button class="btn btn-outline" onclick="hideForm()">å–æ¶ˆ</button>
        </div>
        <div class="panel-body">
          <input type="hidden" id="edit-id">
          
          <div class="form-row">
            <div class="form-group">
              <label>æ•°æ®æºåç§° *</label>
              <input type="text" id="ds-name" placeholder="å¦‚ï¼šç”Ÿäº§æ•°æ®åº“">
            </div>
            <div class="form-group">
              <label>ç±»å‹ *</label>
              <select id="ds-type" onchange="toggleConfigFields()">
                <option value="mysql">MySQL</option>
                <option value="postgres">PostgreSQL</option>
                <option value="file">æ–‡ä»¶ (CSV/Excel/JSON)</option>
                <option value="api">APIæ¥å£</option>
              </select>
            </div>
          </div>

          <!-- æ•°æ®åº“é…ç½® -->
          <div id="db-config" class="form-section">
            <div class="form-section-title">æ•°æ®åº“è¿æ¥é…ç½®</div>
            <div class="form-row">
              <div class="form-group">
                <label>ä¸»æœºåœ°å€</label>
                <input type="text" id="db-host" placeholder="localhost" value="localhost">
              </div>
              <div class="form-group">
                <label>ç«¯å£</label>
                <input type="number" id="db-port" placeholder="3306" value="3306">
              </div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>ç”¨æˆ·å</label>
                <input type="text" id="db-user" placeholder="root">
              </div>
              <div class="form-group">
                <label>å¯†ç </label>
                <input type="password" id="db-password">
              </div>
            </div>
            <div class="form-group">
              <label>æ•°æ®åº“å</label>
              <input type="text" id="db-database" placeholder="mydb">
            </div>
          </div>

          <!-- æ–‡ä»¶é…ç½® -->
          <div id="file-config" class="form-section" style="display:none">
            <div class="form-section-title">æ–‡ä»¶é…ç½®ï¼ˆæ”¯æŒå¤šæ–‡ä»¶ä¸Šä¼ ï¼Œæ¯ä¸ªæ–‡ä»¶ä½œä¸ºä¸€ä¸ªè¡¨ï¼‰</div>
            <div class="form-group">
              <label>æ·»åŠ åˆ°å·²æœ‰æ•°æ®æºï¼ˆå¯é€‰ï¼‰</label>
              <select id="file-target-ds" onchange="onTargetDsChange()">
                <option value="">-- åˆ›å»ºæ–°æ•°æ®æº --</option>
              </select>
            </div>
            <div class="form-group">
              <label>é€‰æ‹©æ–‡ä»¶ä¸Šä¼ ï¼ˆå¯å¤šé€‰ï¼‰*</label>
              <input type="file" id="file-upload" accept=".csv,.xlsx,.xls,.json" multiple onchange="handleFileSelect()">
              <div id="file-info" style="margin-top:8px; font-size:12px; color:#888;"></div>
            </div>
            <div class="form-row">
              <div class="form-group">
                <label>æ–‡ä»¶è·¯å¾„ï¼ˆæ‰‹åŠ¨è¾“å…¥ï¼Œå•æ–‡ä»¶ï¼‰</label>
                <input type="text" id="file-path" placeholder="/path/to/data.csv">
              </div>
              <div class="form-group">
                <label>æ–‡ä»¶ç±»å‹</label>
                <select id="file-type">
                  <option value="csv">CSV</option>
                  <option value="xlsx">Excel (.xlsx)</option>
                  <option value="json">JSON</option>
                </select>
              </div>
            </div>
          </div>

          <!-- APIé…ç½® -->
          <div id="api-config" class="form-section" style="display:none">
            <div class="form-section-title">APIé…ç½®</div>
            <div class="form-row">
              <div class="form-group">
                <label>APIåœ°å€</label>
                <input type="text" id="api-url" placeholder="https://api.example.com/data">
              </div>
              <div class="form-group">
                <label>è¯·æ±‚æ–¹æ³•</label>
                <select id="api-method">
                  <option value="GET">GET</option>
                  <option value="POST">POST</option>
                </select>
              </div>
            </div>
            <div class="form-group">
              <label>Headers (JSONæ ¼å¼ï¼Œå¯é€‰)</label>
              <textarea id="api-headers" rows="2" placeholder='{"Authorization": "Bearer xxx"}'></textarea>
            </div>
          </div>

          <div style="display:flex; gap:10px; margin-top:20px">
            <button class="btn btn-success" onclick="testConnection()">ğŸ”Œ æµ‹è¯•è¿æ¥</button>
            <button class="btn btn-primary" onclick="saveDataSource()">ğŸ’¾ ä¿å­˜</button>
          </div>
          <div id="test-result" style="margin-top:10px"></div>
        </div>
      </div>
    </main>
  </div>

  <script>
    const API_BASE = '';
    let datasources = [];
    let editingId = null;
    let selectedFiles = [];  // æ”¹ä¸ºæ•°ç»„æ”¯æŒå¤šæ–‡ä»¶

    // è®¤è¯æ£€æŸ¥
    function checkAuth() {
      const token = localStorage.getItem('authToken');
      if (!token) {
        window.location.href = '/login.html';
        return false;
      }
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      const name = user.fullName || user.username || 'ç”¨æˆ·';
      const headerNameEl = document.getElementById('headerUserName');
      const headerAvatarEl = document.getElementById('headerAvatar');
      const navNameEl = document.getElementById('navUserName');
      const navAvatarEl = document.getElementById('navAvatar');
      if (headerNameEl) headerNameEl.textContent = name;
      if (navNameEl) navNameEl.textContent = name;
      const initial = String(name).charAt(0).toUpperCase();
      if (headerAvatarEl) headerAvatarEl.textContent = initial;
      if (navAvatarEl) navAvatarEl.textContent = initial;
      return true;
    }

    function logout() {
      localStorage.removeItem('authToken');
      localStorage.removeItem('user');
      window.location.href = '/login.html';
    }

    function getAuthHeaders() {
      return { 'Authorization': 'Bearer ' + localStorage.getItem('authToken'), 'Content-Type': 'application/json' };
    }

    if (!checkAuth()) throw new Error('æœªç™»å½•');

    function handleFileSelect() {
      const fileInput = document.getElementById('file-upload');
      selectedFiles = Array.from(fileInput.files);
      
      if (selectedFiles.length > 0) {
        const fileInfo = document.getElementById('file-info');
        if (selectedFiles.length === 1) {
          const file = selectedFiles[0];
          const sizeMB = (file.size / 1024 / 1024).toFixed(2);
          fileInfo.innerHTML = `âœ“ å·²é€‰æ‹©: ${escapeHtml(file.name)} (${sizeMB}MB)`;
          
          // è‡ªåŠ¨æ£€æµ‹æ–‡ä»¶ç±»å‹
          const ext = file.name.split('.').pop().toLowerCase();
          const typeMap = { 'csv': 'csv', 'xlsx': 'xlsx', 'xls': 'xlsx', 'json': 'json' };
          if (typeMap[ext]) {
            document.getElementById('file-type').value = typeMap[ext];
          }
        } else {
          // å¤šæ–‡ä»¶æ˜¾ç¤º
          const totalSize = selectedFiles.reduce((sum, f) => sum + f.size, 0);
          const sizeMB = (totalSize / 1024 / 1024).toFixed(2);
          const fileNames = selectedFiles.map(f => escapeHtml(f.name)).join('<br>â€¢ ');
          fileInfo.innerHTML = `âœ“ å·²é€‰æ‹© ${selectedFiles.length} ä¸ªæ–‡ä»¶ (å…± ${sizeMB}MB):<br>â€¢ ${fileNames}`;
        }
      } else {
        document.getElementById('file-info').innerHTML = '';
        selectedFiles = [];
      }
    }

    // å½“é€‰æ‹©ç›®æ ‡æ•°æ®æºæ—¶
    function onTargetDsChange() {
      const targetDs = document.getElementById('file-target-ds').value;
      const nameInput = document.getElementById('ds-name');
      if (targetDs) {
        // é€‰æ‹©äº†å·²æœ‰æ•°æ®æºï¼Œç¦ç”¨åç§°è¾“å…¥
        const ds = datasources.find(d => d.id === targetDs);
        nameInput.value = ds ? ds.name : '';
        nameInput.disabled = true;
      } else {
        // åˆ›å»ºæ–°æ•°æ®æº
        nameInput.value = '';
        nameInput.disabled = false;
      }
    }

    // æ›´æ–°æ–‡ä»¶æ•°æ®æºä¸‹æ‹‰åˆ—è¡¨
    function updateFileTargetOptions() {
      const select = document.getElementById('file-target-ds');
      const fileDatasources = datasources.filter(d => d.type === 'file');
      select.innerHTML = '<option value="">-- åˆ›å»ºæ–°æ•°æ®æº --</option>' + 
        fileDatasources.map(d => `<option value="${d.id}">${escapeHtml(d.name)}</option>`).join('');
    }

    async function uploadFile() {
      if (selectedFiles.length === 0) {
        toast('è¯·é€‰æ‹©æ–‡ä»¶', 'error');
        return false;
      }

      const targetDsId = document.getElementById('file-target-ds').value;
      const dsName = document.getElementById('ds-name').value.trim();
      
      if (!targetDsId && !dsName) {
        toast('è¯·è¾“å…¥æ•°æ®æºåç§°', 'error');
        return false;
      }

      const formData = new FormData();
      for (const file of selectedFiles) {
        formData.append('file', file);
      }
      if (targetDsId) {
        formData.append('datasourceId', targetDsId);
      }
      if (dsName) {
        formData.append('name', dsName);
      }

      try {
        toast(`æ­£åœ¨ä¸Šä¼  ${selectedFiles.length} ä¸ªæ–‡ä»¶...`, 'success');
        const res = await fetch(`${API_BASE}/api/upload`, {
          method: 'POST',
          headers: { 'Authorization': 'Bearer ' + localStorage.getItem('authToken') },
          body: formData
        });
        if (res.status === 401) { logout(); return false; }
        const result = await res.json();
        
        if (result.error) {
          toast(`ä¸Šä¼ å¤±è´¥: ${result.error}`, 'error');
          return false;
        } else {
          toast(result.message || 'ä¸Šä¼ æˆåŠŸ', 'success');
          selectedFiles = [];
          document.getElementById('file-upload').value = '';
          document.getElementById('file-info').innerHTML = '';
          hideForm();
          loadDatasources();
          return true;
        }
      } catch (e) {
        toast('ä¸Šä¼ è¯·æ±‚å¤±è´¥', 'error');
        return false;
      }
    }

    async function loadDatasources() {
      try {
        const res = await fetch(`${API_BASE}/api/datasource`, { headers: getAuthHeaders() });
        if (res.status === 401) { logout(); return; }
        if (!res.ok) {
          console.error('è·å–æ•°æ®æºå¤±è´¥:', res.status);
          datasources = [];
        } else {
          datasources = await res.json();
        }
      } catch (e) {
        console.error('è·å–æ•°æ®æºå¼‚å¸¸:', e);
        datasources = [];
      }
      renderList();
      updateFileTargetOptions();
    }

    function renderList() {
      const container = document.getElementById('ds-list');
      if (datasources.length === 0) {
        container.innerHTML = '<div class="empty">æš‚æ— æ•°æ®æºï¼Œç‚¹å‡»ä¸Šæ–¹æŒ‰é’®æ·»åŠ </div>';
        return;
      }
      container.innerHTML = datasources.map(ds => `
        <div class="ds-item">
          <div class="ds-info">
            <div class="name">${escapeHtml(ds.name)}</div>
            <div class="meta">${ds.type.toUpperCase()} ${ds.host ? `Â· ${ds.host}` : ''}</div>
          </div>
          <div class="ds-actions">
            <button class="btn btn-outline" onclick="testById('${ds.id}')">æµ‹è¯•</button>
            <button class="btn btn-outline" onclick="editDataSource('${ds.id}')">ç¼–è¾‘</button>
            <button class="btn btn-danger" onclick="deleteDataSource('${ds.id}')">åˆ é™¤</button>
          </div>
        </div>
      `).join('');
    }

    function showForm(id = null) {
      editingId = id;
      document.getElementById('form-panel').style.display = 'block';
      document.getElementById('form-title').textContent = id ? 'ç¼–è¾‘æ•°æ®æº' : 'æ–°å¢æ•°æ®æº';
      document.getElementById('test-result').innerHTML = '';
      
      if (!id) {
        // æ¸…ç©ºè¡¨å•
        document.getElementById('ds-name').value = '';
        document.getElementById('ds-name').disabled = false;
        document.getElementById('ds-type').value = 'mysql';
        document.getElementById('db-host').value = 'localhost';
        document.getElementById('db-port').value = '3306';
        document.getElementById('db-user').value = '';
        document.getElementById('db-password').value = '';
        document.getElementById('db-database').value = '';
        document.getElementById('file-upload').value = '';
        document.getElementById('file-info').innerHTML = '';
        document.getElementById('file-target-ds').value = '';
        selectedFiles = [];
        updateFileTargetOptions();
        toggleConfigFields();
      }
    }

    function hideForm() {
      document.getElementById('form-panel').style.display = 'none';
      editingId = null;
    }

    function toggleConfigFields() {
      const type = document.getElementById('ds-type').value;
      document.getElementById('db-config').style.display = ['mysql','postgres'].includes(type) ? 'block' : 'none';
      document.getElementById('file-config').style.display = type === 'file' ? 'block' : 'none';
      document.getElementById('api-config').style.display = type === 'api' ? 'block' : 'none';
      
      if (type === 'postgres') {
        document.getElementById('db-port').value = '5432';
      } else if (type === 'mysql') {
        document.getElementById('db-port').value = '3306';
      }
    }

    function getFormData() {
      const type = document.getElementById('ds-type').value;
      const name = document.getElementById('ds-name').value.trim();
      
      if (!name) {
        toast('è¯·è¾“å…¥æ•°æ®æºåç§°', 'error');
        return null;
      }

      let config;
      if (['mysql', 'postgres'].includes(type)) {
        config = {
          host: document.getElementById('db-host').value || 'localhost',
          port: parseInt(document.getElementById('db-port').value) || 3306,
          user: document.getElementById('db-user').value,
          password: document.getElementById('db-password').value,
          database: document.getElementById('db-database').value
        };
        if (!config.user || !config.database) {
          toast('è¯·å¡«å†™ç”¨æˆ·åå’Œæ•°æ®åº“å', 'error');
          return null;
        }
      } else if (type === 'file') {
        config = {
          path: document.getElementById('file-path').value,
          fileType: document.getElementById('file-type').value
        };
        if (!config.path) {
          toast('è¯·å¡«å†™æ–‡ä»¶è·¯å¾„', 'error');
          return null;
        }
      } else {
        let headers = {};
        try { headers = JSON.parse(document.getElementById('api-headers').value || '{}'); } catch {}
        config = {
          url: document.getElementById('api-url').value,
          method: document.getElementById('api-method').value,
          headers
        };
        if (!config.url) {
          toast('è¯·å¡«å†™APIåœ°å€', 'error');
          return null;
        }
      }

      return { name, type, config };
    }

    async function testConnection() {
      const data = getFormData();
      if (!data) return;

      const resultDiv = document.getElementById('test-result');
      resultDiv.innerHTML = '<span class="status status-pending">æµ‹è¯•ä¸­...</span>';

      try {
        const res = await fetch(`${API_BASE}/api/datasource/test`, {
          method: 'POST',
          headers: getAuthHeaders(),
          body: JSON.stringify(data)
        });
        if (res.status === 401) { logout(); return; }
        const result = await res.json();
        
        if (result.success) {
          resultDiv.innerHTML = '<span class="status status-success">âœ“ è¿æ¥æˆåŠŸ</span>';
        } else {
          resultDiv.innerHTML = `<span class="status status-error">âœ— è¿æ¥å¤±è´¥: ${escapeHtml(result.error)}</span>`;
        }
      } catch (e) {
        resultDiv.innerHTML = '<span class="status status-error">âœ— è¯·æ±‚å¤±è´¥</span>';
      }
    }

    async function testById(id) {
      toast('æµ‹è¯•è¿æ¥ä¸­...', 'success');
      try {
        const res = await fetch(`${API_BASE}/api/datasource/${id}/test`, { headers: getAuthHeaders() });
        if (res.status === 401) { logout(); return; }
        const result = await res.json();
        toast(result.success ? 'è¿æ¥æˆåŠŸï¼' : `è¿æ¥å¤±è´¥: ${result.error}`, result.success ? 'success' : 'error');
      } catch {
        toast('æµ‹è¯•è¯·æ±‚å¤±è´¥', 'error');
      }
    }

    async function saveDataSource() {
      const type = document.getElementById('ds-type').value;
      
      // å¦‚æœæ˜¯æ–‡ä»¶ç±»å‹ä¸”é€‰æ‹©äº†æ–‡ä»¶ï¼Œä½¿ç”¨ä¸Šä¼ æ¥å£
      if (type === 'file' && selectedFiles.length > 0) {
        await uploadFile();
        return;
      }

      const data = getFormData();
      if (!data) return;

      try {
        const url = editingId ? `${API_BASE}/api/datasource/${editingId}` : `${API_BASE}/api/datasource`;
        const method = editingId ? 'PUT' : 'POST';
        
        const res = await fetch(url, {
          method,
          headers: getAuthHeaders(),
          body: JSON.stringify(data)
        });
        if (res.status === 401) { logout(); return; }
        const result = await res.json();
        
        if (result.error) {
          toast(result.error, 'error');
        } else {
          toast(editingId ? 'æ›´æ–°æˆåŠŸ' : 'æ·»åŠ æˆåŠŸ', 'success');
          hideForm();
          loadDatasources();
        }
      } catch (e) {
        toast('ä¿å­˜å¤±è´¥', 'error');
      }
    }

    async function editDataSource(id) {
      try {
        const res = await fetch(`${API_BASE}/api/datasource/${id}/detail`, { headers: getAuthHeaders() });
        if (res.status === 401) { logout(); return; }
        const ds = await res.json();
        
        showForm(id);
        document.getElementById('ds-name').value = ds.name;
        document.getElementById('ds-type').value = ds.type;
        toggleConfigFields();
        
        if (['mysql', 'postgres'].includes(ds.type)) {
          document.getElementById('db-host').value = ds.config.host || '';
          document.getElementById('db-port').value = ds.config.port || '';
          document.getElementById('db-user').value = ds.config.user || '';
          document.getElementById('db-password').value = ds.config.password || '';
          document.getElementById('db-database').value = ds.config.database || '';
        } else if (ds.type === 'file') {
          document.getElementById('file-path').value = ds.config.path || '';
          document.getElementById('file-type').value = ds.config.fileType || 'csv';
        } else if (ds.type === 'api') {
          document.getElementById('api-url').value = ds.config.url || '';
          document.getElementById('api-method').value = ds.config.method || 'GET';
          document.getElementById('api-headers').value = JSON.stringify(ds.config.headers || {});
        }
      } catch (e) {
        toast('è·å–è¯¦æƒ…å¤±è´¥', 'error');
      }
    }

    async function deleteDataSource(id) {
      if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ•°æ®æºå—ï¼Ÿ')) return;
      
      try {
        const res = await fetch(`${API_BASE}/api/datasource/${id}`, { method: 'DELETE', headers: getAuthHeaders() });
        if (res.status === 401) { logout(); return; }
        toast('åˆ é™¤æˆåŠŸ', 'success');
        loadDatasources();
      } catch {
        toast('åˆ é™¤å¤±è´¥', 'error');
      }
    }

    function toast(msg, type = 'success') {
      const div = document.createElement('div');
      div.className = `toast toast-${type}`;
      div.textContent = msg;
      document.body.appendChild(div);
      setTimeout(() => div.remove(), 3000);
    }

    function escapeHtml(str) {
      return String(str).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    loadDatasources();
  </script>
</body>
</html>
