<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>知识库管理 - AI 数据平台</title>
<script src="https://cdn.jsdelivr.net/npm/echarts@5/dist/echarts.min.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
  background:#f5f7fb;
}
a{text-decoration:none;color:inherit}
.app-shell{height:100vh;display:flex;background:#f5f7fb}
.sidebar{
  width:230px;
  background:#020617;
  color:#e5edf7;
  display:flex;
  flex-direction:column;
  padding:14px 12px;
  box-shadow:1px 0 0 rgba(15,23,42,0.7)
}
.logo-row{display:flex;align-items:center;gap:8px;padding:8px 8px 14px;border-bottom:1px solid rgba(148,163,184,0.2);margin-bottom:10px}
.logo-mark{width:26px;height:26px;border-radius:8px;background:linear-gradient(135deg,#4f46e5,#8b5cf6);display:flex;align-items:center;justify-content:center;font-size:15px;color:#f9fafb}
.logo-text-main{font-size:15px;font-weight:600}
.logo-text-sub{font-size:11px;color:rgba(148,163,184,0.9)}
.nav-section-title{font-size:11px;text-transform:uppercase;color:rgba(148,163,184,0.8);padding:8px 8px 4px;letter-spacing:.08em}
.nav-list{list-style:none;margin-top:4px}
.nav-item{border-radius:6px;margin-bottom:2px}
.nav-link{display:flex;align-items:center;gap:8px;padding:8px 10px;font-size:13px;border-radius:6px;cursor:pointer;color:#d0e2ff;transition:all .15s}
.nav-icon{width:18px;text-align:center}
.nav-link:hover{background:rgba(59,130,246,0.25)}
.nav-link.active{background:rgba(59,130,246,0.9);color:#f9fafb}
.nav-footer{margin-top:auto;padding:10px 6px 4px;border-top:1px solid rgba(148,163,184,0.2);font-size:11px;color:rgba(148,163,184,0.85)}
.nav-footer-user{display:flex;align-items:center;justify-content:space-between;margin-bottom:4px}
.nav-footer-user-left{display:flex;align-items:center;gap:6px}
.avatar{width:22px;height:22px;border-radius:999px;background:#e5edff;display:flex;align-items:center;justify-content:center;color:#1d4ed8;font-size:11px;font-weight:600}
.logout-link{cursor:pointer;padding:2px 8px;border-radius:999px;border:1px solid rgba(148,163,184,0.6);color:#e5edf7}
.logout-link:hover{background:rgba(239,68,68,0.15);border-color:rgba(248,113,113,0.9);color:#fee2e2}
.main{flex:1;display:flex;flex-direction:column;padding:16px 20px 14px;overflow:hidden}
.top-header{height:52px;background:#fff;border-radius:10px;box-shadow:0 1px 0 rgba(15,23,42,0.04);border:1px solid rgba(226,232,240,0.9);padding:0 16px;display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.breadcrumb{font-size:13px;color:#6b7280;display:flex;align-items:center;gap:6px}
.breadcrumb span.current{color:#111827;font-weight:500}
.header-user{display:flex;align-items:center;gap:8px;font-size:13px;color:#4b5563}
.header-avatar{width:26px;height:26px;border-radius:999px;background:#e5edff;display:flex;align-items:center;justify-content:center;color:#1d4ed8;font-weight:600;font-size:13px}
.container{max-width:1400px;margin:0 auto;padding:0}
.page-title{font-size:18px;font-weight:600;margin:10px 0;color:#111827}
.stats{display:grid;grid-template-columns:repeat(4,1fr);gap:15px;margin-bottom:20px}
.stat-card{background:#fff;padding:20px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.06);transition:transform 0.2s}
.stat-card:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.1)}
.stat-card .num{font-size:28px;font-weight:700;color:#333}
.stat-card .label{font-size:13px;color:#888;margin-top:5px}
.grid{display:grid;grid-template-columns:2fr 1fr;gap:20px}
.card{background:#fff;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,.06);margin-bottom:20px;overflow:hidden}
.card-header{padding:15px 20px;border-bottom:1px solid #eee;font-weight:600;display:flex;justify-content:space-between;align-items:center}
.card-body{padding:20px}
.btn{padding:8px 16px;border:none;border-radius:6px;cursor:pointer;font-size:13px;transition:all 0.2s}
.btn-primary{background:#667eea;color:#fff}
.btn-primary:hover{background:#5a6fd6}
.btn-success{background:#27ae60;color:#fff}
.btn-success:hover{background:#219a52}
.btn-danger{background:#e74c3c;color:#fff}
.btn-danger:hover{background:#c0392b}
.btn-default{background:#f0f2f5;color:#333}
.btn-default:hover{background:#e0e2e5}
.btn-small{padding:6px 12px;font-size:12px}
.input{width:100%;padding:10px 12px;border:1px solid #ddd;border-radius:6px;font-size:14px;margin-bottom:10px}
.input:focus{outline:none;border-color:#667eea}
textarea.input{resize:vertical;min-height:100px;font-family:inherit}
.doc-item{padding:12px 15px;border-bottom:1px solid #f0f0f0;display:flex;justify-content:space-between;align-items:center;transition:background 0.2s}
.doc-item:hover{background:#fafafa}
.doc-item:last-child{border-bottom:none}
.doc-info{flex:1}
.doc-info .title{font-weight:600;font-size:14px;margin-bottom:4px;color:#333}
.doc-info .meta{font-size:12px;color:#888;display:flex;gap:15px;margin-top:4px}
.doc-info .meta span{display:flex;align-items:center;gap:4px}
.doc-actions{display:flex;gap:8px}
.empty{text-align:center;padding:40px;color:#999}
#graphContainer{height:400px;width:100%}
.hidden{display:none}
.panel{margin-top:15px;padding-top:15px;border-top:1px solid #eee}
.chat-box{height:500px;display:flex;flex-direction:column}
.chat-messages{flex:1;overflow-y:auto;padding:15px;background:#fafafa;min-height:0}
.chat-input{display:flex;gap:10px;padding:15px;border-top:1px solid #eee;background:#fff}
.chat-input input{flex:1;margin:0}
.msg{margin-bottom:12px}
.msg.user{text-align:right}
.msg .bubble{display:inline-block;padding:10px 15px;border-radius:12px;max-width:80%;text-align:left;word-wrap:break-word}
.msg.user .bubble{background:#667eea;color:#fff}
.msg.ai .bubble{background:#fff;border:1px solid #eee;color:#333}
.msg.ai .bubble p{margin:4px 0}
.msg.ai .bubble code{background:#f0f2f5;padding:2px 6px;border-radius:4px;font-size:12px}
.msg .sources{margin-top:8px;font-size:11px;color:#888}
.msg .sources a{color:#667eea;text-decoration:none;margin-right:8px}
.msg .confidence{font-size:11px;color:#27ae60;margin-top:4px}
.tabs{display:flex;gap:10px;border-bottom:1px solid #eee;margin-bottom:15px}
.tab{padding:8px 16px;cursor:pointer;border:none;background:none;font-size:14px;color:#666;border-bottom:2px solid transparent;transition:all 0.2s}
.tab:hover{color:#667eea}
.tab.active{color:#667eea;border-bottom-color:#667eea;font-weight:600}
.tab-content{display:none}
.tab-content.active{display:block}
.form-group{margin-bottom:15px}
.form-group label{display:block;margin-bottom:5px;font-size:13px;color:#666;font-weight:500}
.form-group select{width:100%;padding:10px 12px;border:1px solid #ddd;border-radius:6px;font-size:14px}
.file-upload{position:relative;display:inline-block;width:100%}
.file-upload input[type=file]{position:absolute;opacity:0;width:100%;height:100%;cursor:pointer}
.file-upload-label{display:block;padding:40px;border:2px dashed #ddd;border-radius:8px;text-align:center;cursor:pointer;transition:all 0.2s}
.file-upload-label:hover{border-color:#667eea;background:#f8f9ff}
.file-upload-label .icon{font-size:32px;color:#ccc;margin-bottom:10px}
.toast{position:fixed;top:20px;right:20px;padding:12px 20px;border-radius:8px;color:#fff;font-size:14px;z-index:1000;animation:slideIn 0.3s}
.toast-success{background:#27ae60}
.toast-error{background:#e74c3c}
@keyframes slideIn{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
.loading{text-align:center;padding:20px;color:#999}
.tag{display:inline-block;padding:3px 8px;background:#f0f2f5;border-radius:12px;font-size:11px;color:#666;margin-right:6px}
.type-badge{display:inline-block;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:500}
.type-datasource{background:#e3f2fd;color:#1976d2}
.type-document{background:#f3e5f5;color:#7b1fa2}
.type-note{background:#fff3e0;color:#e65100}
.type-webpage{background:#e8f5e9;color:#388e3c}
</style>
</head>
<body>
<div class="app-shell">
  <!-- 侧边导航 -->
  <aside class="sidebar">
    <div class="logo-row">
      <div class="logo-mark">A</div>
      <div>
        <div class="logo-text-main">AI 数据平台</div>
        <div class="logo-text-sub">AI Data Platform</div>
      </div>
    </div>

    <div class="nav-section-title">导航</div>
    <ul class="nav-list">
      <li class="nav-item">
        <div class="nav-link" onclick="location.href='/'">
          <span class="nav-icon">📊</span><span>仪表盘</span>
        </div>
      </li>
      <li class="nav-item">
        <div class="nav-link" onclick="location.href='/datasource.html'">
          <span class="nav-icon">🗄️</span><span>数据源</span>
        </div>
      </li>
      <li class="nav-item">
        <div class="nav-link active" onclick="location.href='/knowledge.html'">
          <span class="nav-icon">📚</span><span>知识库 / RAG</span>
        </div>
      </li>
      <li class="nav-item">
        <div class="nav-link" onclick="location.href='/chat.html'">
          <span class="nav-icon">💬</span><span>对话历史</span>
        </div>
      </li>
      <li class="nav-item">
        <div class="nav-link" onclick="location.href='/admin.html'">
          <span class="nav-icon">👥</span><span>用户与权限</span>
        </div>
      </li>
    </ul>

    <div class="nav-footer">
      <div class="nav-footer-user">
        <div class="nav-footer-user-left">
          <div class="avatar" id="navAvatar">U</div>
          <div>
            <div id="navUserName">用户</div>
          </div>
        </div>
        <div class="logout-link" onclick="logout()">退出</div>
      </div>
    </div>
  </aside>

  <!-- 主内容 -->
  <main class="main">
    <div class="top-header">
      <div class="breadcrumb">
        <span>首页</span><span>/</span><span class="current">知识库管理</span>
      </div>
      <div class="header-user">
        <div class="header-avatar" id="headerAvatar">U</div>
        <span id="headerUserName">用户</span>
      </div>
    </div>

    <div class="container">
      <div class="page-title">知识库管理</div>
<div class="stats">
<div class="stat-card"><div class="num" id="statDocs">0</div><div class="label">文档数</div></div>
<div class="stat-card"><div class="num" id="statChunks">0</div><div class="label">知识块</div></div>
<div class="stat-card"><div class="num" id="statEntities">0</div><div class="label">实体数</div></div>
<div class="stat-card"><div class="num" id="statRelations">0</div><div class="label">关系数</div></div>
</div>

<div class="grid">
<div>
<div class="card">
<div class="card-header">
<span>文档列表</span>
<div>
<button class="btn btn-primary btn-small" onclick="showAddDocForm()">+ 添加文档</button>
<button class="btn btn-default btn-small" onclick="loadDocuments()">刷新</button>
</div>
</div>
  </main>
</div>
<div class="card-body">
<div class="tabs">
<button class="tab active" onclick="switchTab('documents', event)">文档</button>
<button class="tab" onclick="switchTab('upload', event)">上传文件</button>
<button class="tab" onclick="switchTab('datasource', event)">从数据源添加</button>
</div>

<div id="tab-documents" class="tab-content active">
<div id="doc-list" class="loading">加载中...</div>
</div>

<div id="tab-upload" class="tab-content">
<div class="form-group">
<label>上传文件（支持 TXT、PDF、DOCX、MD 等）</label>
<div class="file-upload">
<input type="file" id="fileInput" accept=".txt,.pdf,.docx,.md,.csv,.json">
<label for="fileInput" class="file-upload-label">
<div class="icon">📄</div>
<div>点击或拖拽文件到此处上传</div>
<div style="font-size:12px;color:#999;margin-top:5px">支持多种文档格式</div>
</label>
</div>
</div>
<button class="btn btn-primary" onclick="uploadFile()">上传文件</button>
</div>

<div id="tab-datasource" class="tab-content">
<div class="form-group">
<label>选择数据源</label>
<select id="datasourceSelect">
<option value="">请选择数据源...</option>
</select>
</div>
<button class="btn btn-primary" onclick="addFromDataSource()">添加到知识库</button>
</div>
</div>
</div>

<div class="card" id="add-doc-form" style="display:none">
<div class="card-header">
<span>添加文档</span>
<button class="btn btn-default btn-small" onclick="hideAddDocForm()">取消</button>
</div>
<div class="card-body">
<div class="form-group">
<label>标题 *</label>
<input type="text" id="doc-title" class="input" placeholder="文档标题">
</div>
<div class="form-group">
<label>类型</label>
<select id="doc-type" class="input">
<option value="note">笔记</option>
<option value="document">文档</option>
<option value="webpage">网页</option>
</select>
</div>
<div class="form-group">
<label>内容 *</label>
<textarea id="doc-content" class="input" placeholder="文档内容..."></textarea>
</div>
<div class="form-group">
<label>标签（用逗号分隔）</label>
<input type="text" id="doc-tags" class="input" placeholder="标签1,标签2">
</div>
<button class="btn btn-primary" onclick="addDocument()">添加文档</button>
</div>
</div>
</div>

<div>
<div class="card">
<div class="card-header">知识图谱</div>
<div class="card-body">
<div id="graphContainer"></div>
<div class="panel">
<div class="form-group">
<label>搜索关键词（用逗号分隔）</label>
<input type="text" id="graph-query" class="input" placeholder="关键词1,关键词2">
</div>
<button class="btn btn-primary btn-small" onclick="queryGraph()">查询子图</button>
<button class="btn btn-default btn-small" onclick="loadGraph()">刷新图谱</button>
</div>
</div>
</div>

<div class="card">
<div class="card-header">RAG 问答</div>
<div class="card-body">
<div class="chat-box">
<div class="chat-messages" id="chat-messages">
<div class="empty">开始提问，AI 将基于知识库回答您的问题</div>
</div>
<div class="chat-input">
<input type="text" id="chat-input" placeholder="输入您的问题..." onkeypress="if(event.key==='Enter') askRAG()">
<button class="btn btn-primary" onclick="askRAG()">发送</button>
</div>
</div>
</div>
</div>
</div>
</div>
</div>

<script>
let token = localStorage.getItem('authToken');
let currentUser = null;
let graphChart = null;

// 获取认证头
function getAuthHeaders() {
  return {
    'Authorization': 'Bearer ' + localStorage.getItem('authToken'),
    'Content-Type': 'application/json'
  };
}

// 检查登录状态
async function checkAuth() {
  token = localStorage.getItem('authToken');
  if (!token) {
    window.location.href = '/login.html';
    return;
  }
  try {
    const res = await fetch('/api/auth/me', {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    if (!res.ok) {
      throw new Error('未认证');
    }
    const data = await res.json();
    currentUser = data.user;
    const name = currentUser.fullName || currentUser.username || '用户';
    const headerNameEl = document.getElementById('headerUserName');
    const headerAvatarEl = document.getElementById('headerAvatar');
    const navNameEl = document.getElementById('navUserName');
    const navAvatarEl = document.getElementById('navAvatar');
    if (headerNameEl) headerNameEl.textContent = name;
    if (navNameEl) navNameEl.textContent = name;
    const initial = String(name).charAt(0).toUpperCase();
    if (headerAvatarEl) headerAvatarEl.textContent = initial;
    if (navAvatarEl) navAvatarEl.textContent = initial;
  } catch (e) {
    localStorage.removeItem('authToken');
    window.location.href = '/login.html';
  }
}

// 退出登录
function logout() {
  localStorage.removeItem('authToken');
  localStorage.removeItem('user');
  window.location.href = '/login.html';
}

// 加载统计信息
async function loadStats() {
  try {
    token = localStorage.getItem('authToken');
    const res = await fetch('/api/rag/stats', {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    if (!res.ok) {
      // API失败时使用默认值0
      document.getElementById('statDocs').textContent = 0;
      document.getElementById('statChunks').textContent = 0;
      document.getElementById('statEntities').textContent = 0;
      document.getElementById('statRelations').textContent = 0;
      return;
    }
    const stats = await res.json();
    document.getElementById('statDocs').textContent = stats.documents || 0;
    document.getElementById('statChunks').textContent = stats.chunks || 0;
    document.getElementById('statEntities').textContent = stats.entities || 0;
    document.getElementById('statRelations').textContent = stats.relations || 0;
  } catch (e) {
    console.error('加载统计失败:', e);
    // 确保即使出错也显示默认值
    try {
      document.getElementById('statDocs').textContent = 0;
      document.getElementById('statChunks').textContent = 0;
      document.getElementById('statEntities').textContent = 0;
      document.getElementById('statRelations').textContent = 0;
    } catch (e2) {
      console.error('设置默认统计值失败:', e2);
    }
  }
}

// 加载文档列表
async function loadDocuments() {
  const listEl = document.getElementById('doc-list');
  if (!listEl) {
    console.error('文档列表容器不存在');
    return;
  }
  
  listEl.innerHTML = '<div class="loading">加载中...</div>';
  
  try {
    token = localStorage.getItem('authToken');
    const res = await fetch('/api/rag/documents', {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    if (!res.ok) {
      const errorText = res.status === 404 ? '知识库未初始化' : '加载失败';
      listEl.innerHTML = `<div class="empty">${errorText}</div>`;
      return;
    }
    const docs = await res.json();
    
    if (!Array.isArray(docs)) {
      listEl.innerHTML = '<div class="empty">数据格式错误</div>';
      return;
    }
    
    if (docs.length === 0) {
      listEl.innerHTML = '<div class="empty">暂无文档，点击上方按钮添加</div>';
      return;
    }
    
    listEl.innerHTML = docs.map(doc => `
      <div class="doc-item">
        <div class="doc-info">
          <div class="title">${escapeHtml(doc.title || '未命名文档')}</div>
          <div class="meta">
            <span><span class="type-badge type-${doc.type || 'note'}">${getTypeName(doc.type || 'note')}</span></span>
            <span>📦 ${doc.chunks || 0} 个知识块</span>
            <span>📅 ${formatDate(doc.createdAt)}</span>
            ${doc.tags && doc.tags.length > 0 ? `<span>${doc.tags.map(t => `<span class="tag">${escapeHtml(t)}</span>`).join('')}</span>` : ''}
          </div>
        </div>
        <div class="doc-actions">
          <button class="btn btn-danger btn-small" onclick="deleteDocument('${doc.id}')">删除</button>
        </div>
      </div>
    `).join('');
  } catch (e) {
    console.error('加载文档失败:', e);
    listEl.innerHTML = '<div class="empty">加载失败: ' + escapeHtml(e.message || '未知错误') + '</div>';
  }
}

// 切换标签
function switchTab(tab, event) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  
  if (event && event.target) {
    event.target.classList.add('active');
  } else {
    // 如果没有event，通过tab名称找到对应的按钮
    const tabs = document.querySelectorAll('.tab');
    tabs.forEach((t, index) => {
      if (t.textContent.includes(tab === 'documents' ? '文档' : tab === 'upload' ? '上传' : '数据源')) {
        t.classList.add('active');
      }
    });
  }
  document.getElementById(`tab-${tab}`).classList.add('active');
  
  if (tab === 'datasource') {
    loadDataSources().catch(e => console.error('加载数据源失败:', e));
  }
}

// 显示添加文档表单
function showAddDocForm() {
  document.getElementById('add-doc-form').style.display = 'block';
  document.getElementById('doc-title').value = '';
  document.getElementById('doc-content').value = '';
  document.getElementById('doc-tags').value = '';
  document.getElementById('doc-type').value = 'note';
}

// 隐藏添加文档表单
function hideAddDocForm() {
  document.getElementById('add-doc-form').style.display = 'none';
}

// 添加文档
async function addDocument() {
  const title = document.getElementById('doc-title').value.trim();
  const content = document.getElementById('doc-content').value.trim();
  const type = document.getElementById('doc-type').value;
  const tagsStr = document.getElementById('doc-tags').value.trim();
  const tags = tagsStr ? tagsStr.split(',').map(t => t.trim()).filter(t => t) : [];
  
  if (!title || !content) {
    showToast('请填写标题和内容', 'error');
    return;
  }
  
  try {
    token = localStorage.getItem('authToken');
    const res = await fetch('/api/rag/documents', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ title, content, type, tags })
    });
    
    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.error || '添加失败');
    }
    
    showToast('文档已添加到知识库', 'success');
    hideAddDocForm();
    loadDocuments();
    loadStats();
  } catch (e) {
    showToast('添加失败: ' + e.message, 'error');
  }
}

// 删除文档
async function deleteDocument(id) {
  if (!confirm('确定要删除这个文档吗？')) return;
  
  try {
    token = localStorage.getItem('authToken');
    const res = await fetch(`/api/rag/documents/${id}`, {
      method: 'DELETE',
      headers: { 'Authorization': `Bearer ${token}` }
    });
    
    if (!res.ok) throw new Error('删除失败');
    
    showToast('文档已删除', 'success');
    loadDocuments();
    loadStats();
    loadGraph();
  } catch (e) {
    showToast('删除失败: ' + e.message, 'error');
  }
}

// 上传文件
async function uploadFile() {
  const fileInput = document.getElementById('fileInput');
  const file = fileInput.files[0];
  
  if (!file) {
    showToast('请选择文件', 'error');
    return;
  }
  
  const formData = new FormData();
  formData.append('file', file);
  
  try {
    token = localStorage.getItem('authToken');
    const res = await fetch('/api/rag/upload', {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}` },
      body: formData
    });
    
    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.error || '上传失败');
    }
    
    showToast('文件已添加到知识库', 'success');
    fileInput.value = '';
    loadDocuments();
    loadStats();
  } catch (e) {
    showToast('上传失败: ' + e.message, 'error');
  }
}

// 加载数据源列表
async function loadDataSources() {
  try {
    token = localStorage.getItem('authToken');
    const res = await fetch('/api/datasource', {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    if (!res.ok) throw new Error('加载失败');
    const sources = await res.json();
    
    const select = document.getElementById('datasourceSelect');
    select.innerHTML = '<option value="">请选择数据源...</option>' +
      sources.map(s => `<option value="${s.id}">${escapeHtml(s.name)} (${s.type})</option>`).join('');
  } catch (e) {
    console.error('加载数据源失败:', e);
  }
}

// 从数据源添加
async function addFromDataSource() {
  const datasourceId = document.getElementById('datasourceSelect').value;
  if (!datasourceId) {
    showToast('请选择数据源', 'error');
    return;
  }
  
  try {
    token = localStorage.getItem('authToken');
    const res = await fetch(`/api/rag/datasource/${datasourceId}`, {
      method: 'POST',
      headers: { 'Authorization': `Bearer ${token}` }
    });
    
    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.error || '添加失败');
    }
    
    showToast('数据源已添加到知识库', 'success');
    loadDocuments();
    loadStats();
  } catch (e) {
    showToast('添加失败: ' + e.message, 'error');
  }
}

// 加载知识图谱
async function loadGraph() {
  try {
    token = localStorage.getItem('authToken');
    const res = await fetch('/api/rag/graph', {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    if (!res.ok) {
      // 如果API返回404或500，可能是知识库为空，使用空数据
      if (res.status === 404 || res.status === 500) {
        renderGraph({ entities: [], relations: [] });
        return;
      }
      throw new Error('加载失败');
    }
    const data = await res.json();
    
    renderGraph(data);
  } catch (e) {
    console.error('加载图谱失败:', e);
    // 使用空数据渲染，避免页面崩溃
    renderGraph({ entities: [], relations: [] });
  }
}

// 渲染知识图谱
function renderGraph(data) {
  try {
    const container = document.getElementById('graphContainer');
    if (!container) {
      console.error('图谱容器不存在');
      return;
    }
    
    if (!graphChart) {
      graphChart = echarts.init(container);
    }
    
    // 检查数据是否有效
    if (!data || !data.entities || !Array.isArray(data.entities)) {
      console.warn('图谱数据无效，使用空数据');
      graphChart.setOption({
        title: {
          text: '暂无图谱数据',
          left: 'center',
          top: 'center',
          textStyle: { color: '#999', fontSize: 14 }
        }
      });
      return;
    }
    
    const nodes = data.entities.map(e => ({
      id: e.id,
      name: e.nameCn || e.name,
      category: e.type || 'entity',
      value: 1,
      label: {
        show: true,
        fontSize: 12
      }
    }));
    
    const links = (data.relations || []).map(r => ({
      source: r.source,
      target: r.target,
      value: r.weight || 1,
      label: {
        show: true,
        formatter: r.type || ''
      }
    }));
    
    const categories = Array.from(new Set(nodes.map(n => n.category))).map(c => ({ name: c }));
  
  const option = {
    tooltip: {},
    legend: {
      data: categories.map(c => c.name),
      top: 'top'
    },
    series: [{
      type: 'graph',
      layout: 'force',
      data: nodes,
      links: links,
      categories: categories,
      roam: true,
      label: {
        show: true,
        position: 'right',
        formatter: '{b}'
      },
      labelLayout: {
        hideOverlap: true
      },
      lineStyle: {
        color: 'source',
        curveness: 0.3
      },
      emphasis: {
        focus: 'adjacency',
        lineStyle: {
          width: 4
        }
      },
      force: {
        repulsion: 200,
        gravity: 0.1,
        edgeLength: 100,
        layoutAnimation: true
      }
    }]
  };
  
  graphChart.setOption(option);
  } catch (e) {
    console.error('渲染图谱失败:', e);
    const container = document.getElementById('graphContainer');
    if (container) {
      container.innerHTML = '<div style="text-align:center;padding:40px;color:#999">图谱加载失败</div>';
    }
  }
}

// 查询子图
async function queryGraph() {
  const query = document.getElementById('graph-query').value.trim();
  if (!query) {
    showToast('请输入关键词', 'error');
    return;
  }
  
  const keywords = query.split(',').map(k => k.trim()).filter(k => k);
  
  try {
    token = localStorage.getItem('authToken');
    const res = await fetch('/api/rag/graph/query', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ keywords, maxEntities: 30 })
    });
    
    if (!res.ok) throw new Error('查询失败');
    const data = await res.json();
    
    renderGraph(data);
  } catch (e) {
    showToast('查询失败: ' + e.message, 'error');
  }
}

// RAG 问答
async function askRAG() {
  const input = document.getElementById('chat-input');
  const question = input.value.trim();
  if (!question) return;
  
  const messagesEl = document.getElementById('chat-messages');
  if (messagesEl.querySelector('.empty')) {
    messagesEl.innerHTML = '';
  }
  
  // 添加用户消息
  messagesEl.innerHTML += `
    <div class="msg user">
      <div class="bubble">${escapeHtml(question)}</div>
    </div>
  `;
  messagesEl.scrollTop = messagesEl.scrollHeight;
  
  input.value = '';
  input.disabled = true;
  
  // 添加加载提示
  const loadingId = 'loading-' + Date.now();
  messagesEl.innerHTML += `
    <div class="msg ai" id="${loadingId}">
      <div class="bubble">思考中...</div>
    </div>
  `;
  messagesEl.scrollTop = messagesEl.scrollHeight;
  
  try {
    token = localStorage.getItem('authToken');
    const res = await fetch('/api/rag/ask', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${token}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ question })
    });
    
    if (!res.ok) {
      const err = await res.json();
      throw new Error(err.error || '回答失败');
    }
    
    const result = await res.json();
    
    // 移除加载提示
    document.getElementById(loadingId).remove();
    
    // 添加AI回答
    let sourcesHtml = '';
    if (result.sources && result.sources.length > 0) {
      sourcesHtml = `<div class="sources">来源: ${result.sources.map((s, i) => `<a href="#" onclick="alert('${escapeHtml(s.title || s)}')">文档${i+1}</a>`).join('')}</div>`;
    }
    
    let confidenceHtml = '';
    if (result.confidence !== undefined) {
      confidenceHtml = `<div class="confidence">置信度: ${(result.confidence * 100).toFixed(1)}%</div>`;
    }
    
    messagesEl.innerHTML += `
      <div class="msg ai">
        <div class="bubble">
          ${formatMarkdown(result.answer || '抱歉，无法回答这个问题')}
          ${sourcesHtml}
          ${confidenceHtml}
        </div>
      </div>
    `;
  } catch (e) {
    document.getElementById(loadingId).remove();
    messagesEl.innerHTML += `
      <div class="msg ai">
        <div class="bubble">错误: ${escapeHtml(e.message)}</div>
      </div>
    `;
  }
  
  messagesEl.scrollTop = messagesEl.scrollHeight;
  input.disabled = false;
  input.focus();
}

// 工具函数
function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

function formatDate(timestamp) {
  if (!timestamp) return '-';
  const date = new Date(timestamp);
  return date.toLocaleDateString('zh-CN') + ' ' + date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
}

function getTypeName(type) {
  const names = {
    'datasource': '数据源',
    'document': '文档',
    'note': '笔记',
    'webpage': '网页'
  };
  return names[type] || type;
}

function formatMarkdown(text) {
  // 简单的 markdown 格式化
  return text
    .replace(/\*\*(.+?)\*\*/g, '<strong>$1</strong>')
    .replace(/\*(.+?)\*/g, '<em>$1</em>')
    .replace(/`(.+?)`/g, '<code>$1</code>')
    .replace(/\n/g, '<br>');
}

function showToast(message, type = 'success') {
  const toast = document.createElement('div');
  toast.className = `toast toast-${type}`;
  toast.textContent = message;
  document.body.appendChild(toast);
  
  setTimeout(() => {
    toast.style.animation = 'slideIn 0.3s reverse';
    setTimeout(() => toast.remove(), 300);
  }, 3000);
}

// 初始化
checkAuth().then(() => {
  // 添加错误处理，防止页面崩溃
  try {
    loadStats().catch(e => console.error('加载统计失败:', e));
    loadDocuments().catch(e => console.error('加载文档失败:', e));
    loadGraph().catch(e => console.error('加载图谱失败:', e));
    loadDataSources().catch(e => console.error('加载数据源失败:', e));
  } catch (e) {
    console.error('初始化失败:', e);
    showToast('页面初始化失败，请刷新重试', 'error');
  }
  
  // 窗口大小改变时重新渲染图表
  window.addEventListener('resize', () => {
    if (graphChart) {
      graphChart.resize();
    }
  });
}).catch(e => {
  console.error('认证失败:', e);
  showToast('认证失败，请重新登录', 'error');
  setTimeout(() => {
    window.location.href = '/login.html';
  }, 2000);
});
</script>
</body>
</html>
