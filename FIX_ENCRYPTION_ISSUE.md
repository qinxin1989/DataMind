# 修复加密数据问题

## 问题描述
```
[Crypto] SM4 解密失败: 密文补位无效（Padding invalid）
```

这个错误是因为 `FILE_ENCRYPTION_KEY` 环境变量被修改，导致之前加密的数据无法解密。

## 已完成的修复

✅ 已运行修复脚本 `scripts/fix-encryption-data.ts`，完成以下操作：
- 清空了所有 AI 配置的 API Key
- 清空了所有数据源的加密配置

## 后续步骤

### 1. 重启后端服务

```bash
# 停止当前运行的后端服务（如果有）
# 然后重新启动
npm run dev
```

### 2. 重新配置 AI 模型

访问 **AI 配置** 页面（`/ai/config`），重新输入 API Key：

1. 点击编辑现有的 AI 配置
2. 重新输入 API Key
3. 点击保存

### 3. 重新配置数据源（如果需要）

访问 **数据源管理** 页面，重新配置数据库连接信息：

1. 编辑现有数据源
2. 重新输入数据库密码等敏感信息
3. 测试连接并保存

### 4. 验证修复

重启后端服务后，检查日志中是否还有解密错误。如果没有错误，说明修复成功。

## 预防措施

为了避免将来再次出现此问题：

1. **不要修改** `.env` 文件中的 `FILE_ENCRYPTION_KEY`
2. 如果需要更换密钥，请先导出所有配置，更换密钥后重新导入
3. 定期备份 `.env` 文件

## 如果问题仍然存在

如果重启后仍有解密错误，可以尝试：

```bash
# 完全清空 AI 配置（需要重新配置所有 AI 模型）
npx tsx scripts/clear-ai-configs.ts

# 或者手动在数据库中执行
# DELETE FROM sys_ai_configs;
```

然后重新添加 AI 配置。
