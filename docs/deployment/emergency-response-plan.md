# AI 数据问答平台 - 应急响应预案

**版本**: 1.0.0  
**日期**: 2026-02-01  
**状态**: 生效中

---

## 目录

1. [应急响应概述](#应急响应概述)
2. [应急响应流程](#应急响应流程)
3. [故障分级](#故障分级)
4. [应急场景](#应急场景)
5. [应急联系人](#应急联系人)
6. [应急资源](#应急资源)
7. [演练计划](#演练计划)

---

## 应急响应概述

### 目的

本预案旨在建立快速、有效的应急响应机制，确保在系统发生故障时能够：
- 快速定位问题
- 及时恢复服务
- 减少业务影响
- 防止问题扩大

### 适用范围

本预案适用于以下情况：
- 系统服务中断
- 数据库故障
- 数据丢失或损坏
- 安全事件
- 性能严重下降
- 其他影响业务的重大故障

### 基本原则

1. **快速响应**: 发现问题后立即启动应急响应
2. **分级处理**: 根据故障级别采取相应措施
3. **及时通报**: 及时向相关人员通报情况
4. **记录完整**: 完整记录应急处理过程
5. **事后总结**: 故障恢复后进行复盘总结

---

## 应急响应流程

### 1. 故障发现

**发现渠道**:
- 监控系统告警
- 用户反馈
- 运维巡检
- 自动化测试

**立即行动**:
```bash
# 检查服务状态
pm2 list
pm2 logs --lines 100

# 检查系统资源
top
df -h
free -h

# 检查数据库
mysql -h$DB_HOST -u$DB_USER -p$DB_PASSWORD $DB_NAME -e "SELECT 1;"
```

### 2. 故障评估

**评估内容**:
- 故障范围（影响哪些功能）
- 故障级别（P0/P1/P2/P3）
- 影响用户数量
- 预计恢复时间

**评估工具**:
```bash
# 检查错误日志
tail -f logs/error.log

# 检查访问日志
tail -f logs/access.log

# 检查数据库慢查询
mysql -h$DB_HOST -u$DB_USER -p$DB_PASSWORD -e "SHOW PROCESSLIST;"
```

### 3. 启动应急响应

**P0/P1 级故障**:
- 立即通知应急响应小组
- 启动应急响应会议
- 指定应急响应负责人
- 开始故障处理

**P2/P3 级故障**:
- 通知相关技术人员
- 按正常流程处理
- 定期更新处理进度

### 4. 故障处理

**处理步骤**:
1. 隔离故障（防止扩散）
2. 收集信息（日志、监控数据）
3. 分析原因（定位根本原因）
4. 制定方案（选择最优方案）
5. 执行恢复（按方案执行）
6. 验证恢复（确认服务正常）

### 5. 恢复验证

**验证项目**:
- [ ] 服务状态正常
- [ ] 健康检查通过
- [ ] 核心功能可用
- [ ] 数据完整性正常
- [ ] 性能指标正常
- [ ] 无新增错误日志

**验证命令**:
```bash
# 检查服务
pm2 list
curl http://localhost:3000/health

# 检查数据库
mysql -h$DB_HOST -u$DB_USER -p$DB_PASSWORD $DB_NAME -e "SELECT COUNT(*) FROM sys_users;"

# 检查性能
curl http://localhost:3000/api/monitoring/metrics/realtime
```

### 6. 通报恢复

**通报内容**:
- 故障原因
- 影响范围
- 恢复时间
- 后续措施

**通报对象**:
- 应急响应小组
- 业务负责人
- 受影响用户

### 7. 事后复盘

**复盘内容**:
- 故障时间线
- 根本原因分析
- 处理过程回顾
- 改进措施
- 预防方案

**复盘会议**:
- 时间: 故障恢复后 24 小时内
- 参与人: 应急响应小组 + 相关技术人员
- 输出: 故障复盘报告

---

## 故障分级

### P0 - 紧急故障

**定义**: 系统完全不可用，影响所有用户

**示例**:
- 服务器宕机
- 数据库完全故障
- 网络完全中断
- 数据全部丢失

**响应时间**: 立即（5 分钟内）  
**恢复目标**: 30 分钟内

**处理流程**:
1. 立即通知所有应急响应人员
2. 启动应急响应会议
3. 评估是否需要切换到备用系统
4. 执行最快的恢复方案
5. 每 15 分钟更新一次进度

### P1 - 严重故障

**定义**: 核心功能不可用，影响大部分用户

**示例**:
- 核心 API 故障
- 数据库主从切换
- 关键模块崩溃
- 严重性能下降

**响应时间**: 15 分钟内  
**恢复目标**: 2 小时内

**处理流程**:
1. 通知应急响应小组
2. 评估故障影响
3. 制定恢复方案
4. 执行恢复操作
5. 每 30 分钟更新一次进度

### P2 - 一般故障

**定义**: 部分功能不可用，影响部分用户

**示例**:
- 非核心模块故障
- 部分 API 异常
- 性能轻微下降
- 日志告警

**响应时间**: 1 小时内  
**恢复目标**: 4 小时内

**处理流程**:
1. 通知相关技术人员
2. 分析故障原因
3. 制定修复方案
4. 按计划修复
5. 每 1 小时更新一次进度

### P3 - 轻微故障

**定义**: 不影响核心功能，用户体验轻微下降

**示例**:
- UI 显示异常
- 非关键功能异常
- 监控告警
- 日志错误

**响应时间**: 4 小时内  
**恢复目标**: 1 个工作日内

**处理流程**:
1. 记录问题
2. 安排修复
3. 按正常流程处理
4. 定期跟进进度

---

## 应急场景

### 场景 1: 服务器宕机

**故障级别**: P0

**症状**:
- 服务完全无法访问
- 监控系统无响应
- SSH 无法连接

**应急步骤**:

1. **确认故障**
```bash
# 从其他服务器 ping
ping server-ip

# 检查监控系统
# 查看服务器状态
```

2. **联系机房/云服务商**
- 确认服务器物理状态
- 确认网络连接状态
- 请求重启服务器

3. **切换到备用服务器**（如果有）
```bash
# 更新 DNS 记录
# 或更新负载均衡配置
```

4. **服务器恢复后**
```bash
# 检查系统日志
dmesg
journalctl -xe

# 检查磁盘
df -h
fsck /dev/sda1

# 启动服务
pm2 start pm2.config.js
```

**预计恢复时间**: 30 分钟 - 2 小时

---

### 场景 2: 数据库故障

**故障级别**: P0

**症状**:
- 数据库连接失败
- 查询超时
- 数据损坏

**应急步骤**:

1. **检查数据库状态**
```bash
# 检查 MySQL 进程
ps aux | grep mysql

# 检查 MySQL 状态
systemctl status mysql

# 检查错误日志
tail -f /var/log/mysql/error.log
```

2. **尝试重启数据库**
```bash
# 停止服务
pm2 stop all

# 重启 MySQL
systemctl restart mysql

# 检查连接
mysql -h$DB_HOST -u$DB_USER -p$DB_PASSWORD $DB_NAME -e "SELECT 1;"
```

3. **如果重启失败，恢复备份**
```bash
# 停止服务
pm2 stop all

# 恢复最新备份
./scripts/restore-backup.sh -t database

# 启动服务
pm2 start pm2.config.js
```

4. **如果主库故障，切换到从库**
```bash
# 提升从库为主库
mysql -h$SLAVE_HOST -u$DB_USER -p$DB_PASSWORD -e "STOP SLAVE; RESET SLAVE ALL;"

# 更新应用配置
vi .env.production
# 修改 DB_HOST 为从库地址

# 重启服务
pm2 restart all
```

**预计恢复时间**: 15 分钟 - 1 小时

---

### 场景 3: 数据丢失

**故障级别**: P1

**症状**:
- 数据查询返回空
- 数据不完整
- 数据被误删除

**应急步骤**:

1. **立即停止服务**
```bash
pm2 stop all
```

2. **评估数据丢失范围**
```sql
-- 检查表数据量
SELECT COUNT(*) FROM sys_users;
SELECT COUNT(*) FROM sys_modules;

-- 检查最新数据
SELECT * FROM sys_users ORDER BY created_at DESC LIMIT 10;
```

3. **恢复数据**

**方案 A: 从备份恢复**
```bash
# 恢复最新备份
./scripts/restore-backup.sh -t database
```

**方案 B: 从 binlog 恢复**
```bash
# 查找 binlog 位置
mysql -e "SHOW MASTER STATUS;"

# 恢复 binlog
mysqlbinlog --start-datetime="2026-02-01 00:00:00" \
            --stop-datetime="2026-02-01 23:59:59" \
            /var/log/mysql/mysql-bin.000001 | mysql $DB_NAME
```

**方案 C: 从从库恢复**
```bash
# 从从库导出数据
mysqldump -h$SLAVE_HOST -u$DB_USER -p$DB_PASSWORD $DB_NAME > slave_backup.sql

# 导入主库
mysql -h$DB_HOST -u$DB_USER -p$DB_PASSWORD $DB_NAME < slave_backup.sql
```

4. **验证数据**
```sql
-- 验证数据量
SELECT COUNT(*) FROM sys_users;

-- 验证数据完整性
SELECT * FROM sys_users WHERE id = 1;
```

5. **启动服务**
```bash
pm2 start pm2.config.js
```

**预计恢复时间**: 30 分钟 - 2 小时

---

### 场景 4: 磁盘空间不足

**故障级别**: P1

**症状**:
- 写入操作失败
- 日志停止记录
- 服务异常

**应急步骤**:

1. **检查磁盘使用情况**
```bash
# 检查磁盘空间
df -h

# 查找大文件
du -sh /* | sort -rh | head -10
du -sh /path/to/ai-data-platform/* | sort -rh | head -10
```

2. **清理空间**

**清理日志文件**:
```bash
# 清理旧日志
find logs -name "*.log" -mtime +7 -delete

# 清理 PM2 日志
pm2 flush

# 清理系统日志
journalctl --vacuum-time=7d
```

**清理备份文件**:
```bash
# 清理旧备份
find backups -type d -mtime +7 -exec rm -rf {} +
```

**清理临时文件**:
```bash
# 清理临时文件
rm -rf /tmp/*
rm -rf uploads/temp/*
```

3. **扩展磁盘**（如果需要）
```bash
# 云服务器扩展磁盘
# 1. 在控制台扩展磁盘
# 2. 扩展分区
growpart /dev/vda 1

# 3. 扩展文件系统
resize2fs /dev/vda1  # ext4
xfs_growfs /         # xfs
```

4. **验证**
```bash
# 检查磁盘空间
df -h

# 重启服务
pm2 restart all
```

**预计恢复时间**: 15 分钟 - 1 小时

---

### 场景 5: 内存溢出

**故障级别**: P1

**症状**:
- 服务频繁重启
- 响应缓慢
- OOM 错误

**应急步骤**:

1. **检查内存使用**
```bash
# 检查内存
free -h

# 检查进程内存
ps aux --sort=-%mem | head -10

# 检查 Node.js 内存
pm2 monit
```

2. **重启服务**
```bash
# 重启应用
pm2 restart all

# 清理缓存
redis-cli FLUSHALL
```

3. **调整内存限制**
```bash
# 增加 Node.js 内存限制
export NODE_OPTIONS="--max-old-space-size=4096"

# 更新 PM2 配置
vi pm2.config.js
# 修改 max_memory_restart: '2G'

# 重启
pm2 restart all
```

4. **优化代码**（长期）
- 检查内存泄漏
- 优化数据结构
- 减少内存占用

**预计恢复时间**: 15 分钟 - 30 分钟

---

### 场景 6: 安全事件

**故障级别**: P0/P1

**症状**:
- 异常登录
- 数据被篡改
- 恶意请求
- DDoS 攻击

**应急步骤**:

1. **立即隔离**
```bash
# 停止服务
pm2 stop all

# 断开网络（如果必要）
iptables -A INPUT -j DROP
```

2. **收集证据**
```bash
# 保存日志
cp -r logs logs_backup_$(date +%Y%m%d_%H%M%S)

# 保存访问日志
cp /var/log/nginx/access.log access_log_backup_$(date +%Y%m%d_%H%M%S)

# 检查异常进程
ps aux | grep -v grep

# 检查网络连接
netstat -antp
```

3. **分析攻击**
```bash
# 分析访问日志
awk '{print $1}' /var/log/nginx/access.log | sort | uniq -c | sort -rn | head -20

# 检查异常 IP
grep "POST" /var/log/nginx/access.log | awk '{print $1}' | sort | uniq -c | sort -rn
```

4. **封禁攻击源**
```bash
# 封禁 IP
iptables -A INPUT -s 攻击IP -j DROP

# 或使用 fail2ban
fail2ban-client set nginx-limit-req banip 攻击IP
```

5. **恢复服务**
```bash
# 恢复备份（如果数据被篡改）
./scripts/restore-backup.sh

# 启动服务
pm2 start pm2.config.js

# 启用防护
# 配置 WAF
# 启用 DDoS 防护
```

6. **加固安全**
- 修改所有密码
- 更新安全补丁
- 加强访问控制
- 启用审计日志

**预计恢复时间**: 1 小时 - 4 小时

---

## 应急联系人

### 应急响应小组

| 角色 | 姓名 | 电话 | 邮箱 | 职责 |
|------|------|------|------|------|
| 应急响应负责人 | [姓名] | [电话] | [邮箱] | 统筹应急响应 |
| 运维负责人 | [姓名] | [电话] | [邮箱] | 系统运维 |
| 开发负责人 | [姓名] | [电话] | [邮箱] | 代码修复 |
| 数据库管理员 | [姓名] | [电话] | [邮箱] | 数据库管理 |
| 安全负责人 | [姓名] | [电话] | [邮箱] | 安全事件处理 |
| 业务负责人 | [姓名] | [电话] | [邮箱] | 业务决策 |

### 外部联系人

| 类型 | 联系方式 | 说明 |
|------|---------|------|
| 云服务商 | [电话/工单] | 服务器、网络问题 |
| 机房 | [电话] | 物理服务器问题 |
| 网络运营商 | [电话] | 网络问题 |
| 安全厂商 | [电话] | 安全事件 |

### 通知渠道

- **紧急通知**: 电话
- **一般通知**: 邮件、企业微信
- **状态更新**: 工作群、状态页面

---

## 应急资源

### 备用系统

| 资源 | 位置 | 说明 |
|------|------|------|
| 备用服务器 | [IP/域名] | 用于紧急切换 |
| 备用数据库 | [IP/域名] | 从库或备库 |
| 备用存储 | [OSS/S3] | 远程备份 |

### 应急工具

| 工具 | 用途 | 位置 |
|------|------|------|
| 备份脚本 | 数据备份 | scripts/backup-*.sh |
| 恢复脚本 | 数据恢复 | scripts/restore-backup.sh |
| 监控系统 | 故障发现 | http://monitor.example.com |
| 日志系统 | 问题分析 | logs/ |

### 应急文档

| 文档 | 说明 | 位置 |
|------|------|------|
| 部署指南 | 系统部署 | docs/deployment/deployment-guide.md |
| 备份指南 | 备份恢复 | docs/deployment/backup-guide.md |
| 监控指南 | 监控配置 | docs/deployment/monitoring-guide.md |
| 应急预案 | 应急响应 | docs/deployment/emergency-response-plan.md |

---

## 演练计划

### 演练目的

- 验证应急预案有效性
- 提高应急响应能力
- 发现潜在问题
- 培训应急人员

### 演练类型

**桌面演练**:
- 频率: 每季度一次
- 形式: 会议讨论
- 内容: 模拟故障场景，讨论应对方案

**实战演练**:
- 频率: 每半年一次
- 形式: 实际操作
- 内容: 在测试环境模拟真实故障

### 演练场景

1. **数据库故障演练**
   - 模拟数据库宕机
   - 执行恢复流程
   - 验证恢复效果

2. **数据恢复演练**
   - 模拟数据丢失
   - 从备份恢复数据
   - 验证数据完整性

3. **服务器故障演练**
   - 模拟服务器宕机
   - 切换到备用服务器
   - 验证服务可用性

4. **安全事件演练**
   - 模拟安全攻击
   - 执行应急响应
   - 验证防护措施

### 演练记录

每次演练后记录：
- 演练时间
- 参与人员
- 演练场景
- 发现问题
- 改进措施

---

## 附录

### 故障报告模板

```markdown
# 故障报告

## 基本信息
- 故障时间: YYYY-MM-DD HH:MM:SS
- 恢复时间: YYYY-MM-DD HH:MM:SS
- 故障级别: P0/P1/P2/P3
- 影响范围: 
- 负责人: 

## 故障描述
[详细描述故障现象]

## 故障原因
[根本原因分析]

## 处理过程
[详细记录处理步骤]

## 恢复验证
[验证结果]

## 改进措施
[预防措施和改进建议]

## 附件
[相关日志、截图等]
```

### 应急响应检查清单

#### 故障发现阶段
- [ ] 确认故障现象
- [ ] 评估故障级别
- [ ] 通知相关人员
- [ ] 启动应急响应

#### 故障处理阶段
- [ ] 隔离故障
- [ ] 收集信息
- [ ] 分析原因
- [ ] 制定方案
- [ ] 执行恢复
- [ ] 定期更新进度

#### 恢复验证阶段
- [ ] 检查服务状态
- [ ] 验证核心功能
- [ ] 检查数据完整性
- [ ] 监控系统指标
- [ ] 确认无新增错误

#### 事后处理阶段
- [ ] 通报恢复
- [ ] 编写故障报告
- [ ] 组织复盘会议
- [ ] 制定改进措施
- [ ] 更新应急预案

---

**最后更新**: 2026-02-01  
**版本**: 1.0.0  
**审批人**: [姓名]  
**生效日期**: 2026-02-01
